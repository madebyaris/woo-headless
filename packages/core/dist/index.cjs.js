"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("zod"),t=require("fuse.js");function r(e){return{success:!0,data:e}}function i(e){return{success:!1,error:e}}function a(e){return e.success}function s(e){return!e.success}function n(e){if(a(e))return e.data;throw new Error(`Called unwrap on Err: ${JSON.stringify(e.error)}`)}function o(e){if(s(e))return e.error;throw new Error(`Called unwrapErr on Ok: ${JSON.stringify(e.data)}`)}class c extends Error{constructor(e,t,r){super(e),this.details=t,this.code="NETWORK_ERROR",this.retryable=!0,this.name="NetworkError",this.timestamp=new Date,void 0!==r&&(this.statusCode=r)}}class d extends Error{constructor(e,t,r){super(e),this.details=t,this.code="AUTH_ERROR",this.retryable=!1,this.name="AuthError",this.timestamp=new Date,void 0!==r&&(this.statusCode=r)}}class u extends Error{constructor(e,t){super(e),this.details=t,this.code="VALIDATION_ERROR",this.retryable=!1,this.name="ValidationError",this.timestamp=new Date}}class l extends Error{constructor(e,t,r){super(e),this.statusCode=t,this.details=r,this.code="API_ERROR",this.name="ApiError",this.timestamp=new Date,this.retryable=t>=500}}class h extends Error{constructor(e,t,r){super(e),this.retryAfter=t,this.details=r,this.code="RATE_LIMIT_ERROR",this.retryable=!0,this.name="RateLimitError",this.timestamp=new Date}}class p extends Error{constructor(e,t,r){super(e),this.timeout=t,this.details=r,this.code="TIMEOUT_ERROR",this.retryable=!0,this.name="TimeoutError",this.timestamp=new Date}}class m extends Error{constructor(e,t){super(e),this.details=t,this.code="CONFIGURATION_ERROR",this.retryable=!1,this.name="ConfigurationError",this.timestamp=new Date}}class g extends Error{constructor(e,t){super(`Product with ID ${e} not found`),this.productId=e,this.details=t,this.code="PRODUCT_NOT_FOUND",this.retryable=!1,this.name="ProductNotFoundError",this.timestamp=new Date}}class y extends Error{constructor(e,t){super(e),this.details=t,this.code="CART_ERROR",this.retryable=!1,this.name="CartError",this.timestamp=new Date}}class f extends Error{constructor(e,t){super(e),this.details=t,this.code="CHECKOUT_ERROR",this.retryable=!1,this.name="CheckoutError",this.timestamp=new Date}}class v extends Error{constructor(e,t,r){super(e),this.details=t,this.code="PAYMENT_ERROR",this.retryable=!1,this.name="PaymentError",this.timestamp=new Date,void 0!==r&&(this.statusCode=r)}}class w{static networkError(e,t,r){return new c(e,t,r)}static authError(e,t,r){return new d(e,t,r)}static validationError(e,t){return new u(e,t)}static apiError(e,t,r){return new l(e,t,r)}static rateLimitError(e,t,r){return new h(e,t,r)}static timeoutError(e,t,r){return new p(e,t,r)}static configurationError(e,t){return new m(e,t)}static productNotFoundError(e,t){return new g(e,t)}static cartError(e,t){return new y(e,t)}static checkoutError(e,t){return new f(e,t)}static paymentError(e,t,r){return new v(e,t,r)}static cacheError(e,t){return new S(e,t)}static notImplementedError(e,t){return new m(`Not implemented: ${e}`,t)}static persistenceError(e,t){return new S(`Persistence error: ${e}`,t)}}class S extends Error{constructor(e,t){super(e),this.details=t,this.code="CACHE_ERROR",this.retryable=!1,this.name="CacheError",this.timestamp=new Date}}const b=e.z.object({id:e.z.number(),name:e.z.string(),slug:e.z.string(),status:e.z.enum(["draft","pending","private","publish"]),featured:e.z.boolean(),catalog_visibility:e.z.enum(["visible","catalog","search","hidden"]),description:e.z.string(),short_description:e.z.string(),price:e.z.string(),regular_price:e.z.string(),sale_price:e.z.string(),on_sale:e.z.boolean(),stock_status:e.z.enum(["instock","outofstock","onbackorder"]),manage_stock:e.z.boolean(),stock_quantity:e.z.number().optional(),categories:e.z.array(e.z.object({id:e.z.number(),name:e.z.string(),slug:e.z.string()})),images:e.z.array(e.z.object({id:e.z.number(),src:e.z.string(),name:e.z.string(),alt:e.z.string()}))}),C=e.z.object({id:e.z.number(),status:e.z.enum(["pending","processing","on-hold","completed","cancelled","refunded","failed","trash"]),currency:e.z.string(),total:e.z.string(),customer_id:e.z.number(),billing:e.z.object({first_name:e.z.string(),last_name:e.z.string(),email:e.z.string(),phone:e.z.string()}),line_items:e.z.array(e.z.object({id:e.z.number(),name:e.z.string(),product_id:e.z.number(),quantity:e.z.number(),total:e.z.string()}))});const I={version:"wc/v3",environment:"production",cache:{enabled:!0,ttl:3e5,storage:"localStorage",maxSize:50,prefix:"woo-headless"},auth:{enabled:!1,expiresIn:3600,autoRefresh:!0,refreshThreshold:300},http:{timeout:3e4,retries:3,retryDelay:1e3,maxRetryDelay:1e4,retryCondition:e=>e instanceof Error&&(e.message.includes("network")||e.message.includes("timeout")||e.message.includes("5"))},search:{fuzzyThreshold:.3,maxResults:50,enableHighlight:!0,enableSuggestions:!0,cacheResults:!0,enableAnalytics:!1},advancedSearch:{fuzzy:{enabled:!0,threshold:.3,distance:100,minMatchCharLength:1,includeScore:!0},highlighting:{enabled:!0,preTag:"<mark>",postTag:"</mark>",fragmentSize:150,maxFragments:3},suggestions:{enabled:!0,maxSuggestions:10,minQueryLength:2,showPopular:!0,showRecent:!0},facets:{enabled:!0,maxFacets:10,maxFacetValues:20,minDocumentCount:1},analytics:{enabled:!1,trackQueries:!0,trackFilters:!0,trackClicks:!0,trackConversions:!1,sessionTimeout:30},caching:{enabled:!0,ttl:3e5,maxCacheSize:100,cacheKey:"woo-search"},performance:{maxResults:1e3,searchTimeout:5e3,debounceDelay:300,prefetchResults:!1}},analytics:{enabled:!1,trackPageViews:!1,trackSearches:!1,trackConversions:!1},i18n:{locale:"en-US",currency:"USD",timezone:"UTC",dateFormat:"YYYY-MM-DD",numberFormat:{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2}},debug:{enabled:!1,logLevel:"error",performanceMonitoring:!1,errorReporting:!1,apiLogging:!1},cart:{persistence:{strategy:"localStorage",key:"woo-headless-cart",encryption:!1,expirationDays:30,syncToServer:!1},sync:{enabled:!1,strategy:"merge_smart",syncIntervalMs:3e4,conflictResolution:"merge_smart",maxRetries:3,retryDelayMs:1e3,syncOnAuth:!0,syncOnCartChange:!1,backgroundSync:!0,offlineQueueSize:50},autoCalculateTotals:!0,validateStock:!0,allowBackorders:!1,sessionTimeout:60,maxItems:100,maxQuantityPerItem:999,enableCoupons:!0,enableShipping:!0,enableFees:!0,enableCrossSells:!0,taxCalculation:{enabled:!0,pricesIncludeTax:!1,displayMode:"excl",roundAtSubtotal:!1}},userSync:{enabled:!1,syncInterval:300,syncOnLogin:!0,syncProfile:!0,syncAddresses:!0,syncPreferences:!0,syncOrderHistory:!0,syncWishlist:!0,maxOrderHistory:50,cacheUserData:!0,cacheTtl:18e5},checkout:{address:{firstName:!0,lastName:!0,company:!1,address1:!0,address2:!1,city:!0,state:!0,postcode:!0,country:!0,email:!0,phone:!1},shipping:{enabled:!0,calculateTax:!0,defaultCountry:"US",restrictedCountries:[],cacheTimeout:15},payment:{enabled:!0,testMode:!0,supportedMethods:["stripe","paypal","bank_transfer","cash_on_delivery"],minimumAmount:1,currency:"USD",returnUrl:"/checkout/payment/return",cancelUrl:"/checkout/payment/cancel",cacheTimeout:10},flow:{steps:["billing_address","shipping_method","payment_method","order_review"],allowSkipOptional:!1,persistSession:!0,sessionTimeout:30,autoAdvance:!1,validationRules:{requireShippingAddress:!0,requireBillingAddress:!0,requirePhoneNumber:!1,requireCompanyName:!1,allowGuestCheckout:!0,minimumOrderAmount:0,restrictedCountries:[],requiredFields:[]}},order:{autoUpdateInventory:!0,sendConfirmationEmail:!0,requirePaymentConfirmation:!0,orderNumberPrefix:"WOO-",defaultStatus:"pending",inventoryHoldMinutes:15,cacheTimeout:30},validation:{requireShippingAddress:!0,requireBillingAddress:!0,requirePhoneNumber:!1,requireCompanyName:!1,allowGuestCheckout:!0,minimumOrderAmount:0,restrictedCountries:[],requiredFields:[]}}};function x(e){try{return new URL(e),!0}catch{return!1}}function E(e,t){return e.trim().length>0&&t.trim().length>0}function k(e){return!(void 0!==e.ttl&&e.ttl<0)&&!(void 0!==e.maxSize&&e.maxSize<=0)}class _{constructor(e){this.requestInterceptors=[],this.responseInterceptors=[],this.errorInterceptors=[],this.abortControllers=new Map,this.config=e.http,this.baseURL=`${e.baseURL}/wp-json/${e.version}`}addRequestInterceptor(e){this.requestInterceptors.push(e)}addResponseInterceptor(e){this.responseInterceptors.push(e)}addErrorInterceptor(e){this.errorInterceptors.push(e)}async request(e){const t=this.generateRequestId();try{let a={...e};for(const e of this.requestInterceptors)a=await e(a);const s=await this.attemptRequest(a,t);if(s.success){let e=s.data;for(const t of this.responseInterceptors)e=await t(e);return r(e)}{let e=s.error;for(const t of this.errorInterceptors)e=await t(e);return i(e)}}catch(a){return i(this.createErrorFromException(a))}finally{this.abortControllers.delete(t)}}async get(e,t){const r={method:"GET",url:e};return void 0!==t&&(r.headers=t),this.request(r)}async post(e,t,r){const i={method:"POST",url:e};return void 0!==t&&(i.body=t),void 0!==r&&(i.headers=r),this.request(i)}async put(e,t,r){const i={method:"PUT",url:e};return void 0!==t&&(i.body=t),void 0!==r&&(i.headers=r),this.request(i)}async patch(e,t,r){const i={method:"PATCH",url:e};return void 0!==t&&(i.body=t),void 0!==r&&(i.headers=r),this.request(i)}async delete(e,t){const r={method:"DELETE",url:e};return void 0!==t&&(r.headers=t),this.request(r)}cancelRequest(e){const t=this.abortControllers.get(e);t&&(t.abort(),this.abortControllers.delete(e))}cancelAllRequests(){for(const e of this.abortControllers.values())e.abort();this.abortControllers.clear()}async attemptRequest(e,t){const r=e.retries??this.config.retries;let a=null;for(let i=0;i<=r;i++)try{const s=await this.executeRequest(e,t);if(s.success)return s;if(a=s.error,!this.shouldRetry(a,i,r))break;i<r&&await this.delay(this.calculateRetryDelay(i))}catch(s){if(a=this.createErrorFromException(s),!this.shouldRetry(a,i,r))break;i<r&&await this.delay(this.calculateRetryDelay(i))}return i(a??w.networkError("Unknown error occurred"))}async executeRequest(e,t){const a=new AbortController;this.abortControllers.set(t,a);const s=this.buildURL(e.url),n=e.timeout??this.config.timeout,o=setTimeout(()=>{a.abort()},n);try{const t={method:e.method,headers:this.buildHeaders(e.headers),signal:a.signal},n=this.buildBody(e.body);void 0!==n&&(t.body=n);const c=await fetch(s,t);if(clearTimeout(o),!c.ok)return i(await this.createErrorFromResponse(c));const d=await this.parseResponse(c),u=this.extractHeaders(c);return r({data:d,status:c.status,statusText:c.statusText,headers:u})}catch(c){return clearTimeout(o),a.signal.aborted?i(w.timeoutError("Request timeout",n)):i(this.createErrorFromException(c))}}buildURL(e){const t=e.startsWith("/")?e.slice(1):e;return`${this.baseURL}/${t}`}buildHeaders(e){return{...{"Content-Type":"application/json",Accept:"application/json","User-Agent":"WooHeadless-SDK/1.0.0",...this.config.headers},...e}}buildBody(e){if(e)return"string"==typeof e?e:JSON.stringify(e)}async parseResponse(e){const t=e.headers.get("content-type")||"";return t.includes("application/json")?e.json():t.includes("text/")?e.text():e.json()}extractHeaders(e){const t={};return e.headers.forEach((e,r)=>{t[r]=e}),t}async createErrorFromResponse(e){const t=e.status,r=e.statusText;if(429===t){const t=e.headers.get("retry-after");return w.rateLimitError("Rate limit exceeded",t?parseInt(t):void 0)}if(401===t||403===t)return w.authError(`Authentication failed: ${r}`,void 0,t);let i;try{i=await e.json()}catch{i=await e.text()}return w.apiError(`HTTP ${t}: ${r}`,t,i)}createErrorFromException(e){if(e instanceof Error){if("AbortError"===e.name)return w.timeoutError("Request was aborted",this.config.timeout);if(e.message.includes("network")||e.message.includes("fetch"))return w.networkError(e.message)}return w.networkError(e instanceof Error?e.message:"Unknown network error")}shouldRetry(e,t,r){return!(t>=r)&&(this.config.retryCondition?this.config.retryCondition(e):!0===e.retryable)}calculateRetryDelay(e){const t=this.config.retryDelay*Math.pow(2,e)+1e3*Math.random();return Math.min(t,this.config.maxRetryDelay)}delay(e){return new Promise(t=>setTimeout(t,e))}generateRequestId(){return`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}class A{constructor(e="woo-headless"){this.prefix=e}async get(e){try{return localStorage.getItem(`${this.prefix}:${e}`)}catch{return null}}async set(e,t){try{localStorage.setItem(`${this.prefix}:${e}`,t)}catch{}}async remove(e){try{localStorage.removeItem(`${this.prefix}:${e}`)}catch{}}async clear(){try{const e=Object.keys(localStorage);for(const t of e)t.startsWith(`${this.prefix}:`)&&localStorage.removeItem(t)}catch{}}}class T{constructor(e="woo-headless"){this.store=new Map,this.prefix=e}async get(e){return this.store.get(`${this.prefix}:${e}`)??null}async set(e,t){this.store.set(`${this.prefix}:${e}`,t)}async remove(e){this.store.delete(`${this.prefix}:${e}`)}async clear(){const e=Array.from(this.store.keys());for(const t of e)t.startsWith(`${this.prefix}:`)&&this.store.delete(t)}}class P{constructor(e,t){this.currentToken=null,this.refreshTimer=null,this.config=e.auth,t?this.storage=t:"undefined"!=typeof window?this.storage=new A(e.cache.prefix):this.storage=new T(e.cache.prefix),this.initializeToken()}async initializeToken(){try{const e=await this.storage.get("token");if(e){const t=JSON.parse(e);this.isTokenValid(t)?(this.currentToken=t,this.scheduleRefresh()):await this.clearToken()}}catch{await this.clearToken()}}async setToken(e){this.currentToken=e,await this.storage.set("token",JSON.stringify(e)),this.scheduleRefresh()}getToken(){return this.currentToken&&this.isTokenValid(this.currentToken)?this.currentToken.token:null}isAuthenticated(){return null!==this.getToken()}async validateToken(){return this.currentToken?this.isTokenValid(this.currentToken)?r(!0):(await this.clearToken(),r(!1)):r(!1)}async clearToken(){this.currentToken=null,await this.storage.remove("token"),this.clearRefreshTimer()}async logout(){return await this.clearToken(),r(void 0)}createTokenFromAuthResponse(e){if(!e.success||!e.data.token)return i(w.authError("Invalid authentication response"));const t=new Date,a=new Date(1e3*e.data.expires);return r({token:e.data.token,expiresAt:a,issuedAt:t})}getAuthorizationHeader(){const e=this.getToken();if(e)return{Authorization:`Bearer ${e}`}}scheduleRefresh(){if(this.clearRefreshTimer(),!this.config.autoRefresh||!this.currentToken)return;const e=this.config.refreshThreshold??300,t=this.currentToken.expiresAt.getTime()-Date.now()-1e3*e;t>0&&(this.refreshTimer=setTimeout(()=>{this.handleTokenRefresh()},t))}async handleTokenRefresh(){await this.clearToken()}clearRefreshTimer(){this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null)}isTokenValid(e){return e.expiresAt.getTime()>Date.now()}static generateBasicAuth(e,t){return`Basic ${btoa(`${e}:${t}`)}`}static createOAuthSignature(e,t,r,i,a={}){const s=Math.floor(Date.now()/1e3).toString(),n={oauth_consumer_key:e,oauth_nonce:Math.random().toString(36).substring(2,15),oauth_signature_method:"HMAC-SHA1",oauth_timestamp:s,oauth_version:"1.0",...a},o=Object.keys(n).sort().map(e=>{const t=n[e];return`${e}=${encodeURIComponent(t??"")}`}).join("&"),c=`${i.toUpperCase()}&${encodeURIComponent(r)}&${encodeURIComponent(o)}`,d=`${encodeURIComponent(t)}&`,u=btoa(c+d);return{...n,oauth_signature:u}}}class R{static resolveConfig(e){const t=this.validateConfig(e);if(!t.success)return t;return r({baseURL:e.baseURL,consumerKey:e.consumerKey,consumerSecret:e.consumerSecret,version:e.version??I.version,environment:e.environment??I.environment,cache:{...I.cache,...e.cache},auth:{...I.auth,...e.auth},http:{...I.http,...e.http},search:{...I.search,...e.search},analytics:{...I.analytics,...e.analytics},i18n:{...I.i18n,...e.i18n},debug:{...I.debug,...e.debug},advancedSearch:{...I.advancedSearch,...e.advancedSearch},cart:{...I.cart,...e.cart},userSync:{...I.userSync,...e.userSync},checkout:{...I.checkout,...e.checkout}})}static validateConfig(e){return x(e.baseURL)?E(e.consumerKey,e.consumerSecret)?e.cache&&!k(e.cache)?i(w.configurationError("Invalid cache configuration.",{cache:e.cache})):void 0!==e.search?.fuzzyThreshold&&(e.search.fuzzyThreshold<0||e.search.fuzzyThreshold>1)?i(w.configurationError("Search fuzzyThreshold must be between 0 and 1.",{fuzzyThreshold:e.search.fuzzyThreshold})):void 0!==e.search?.maxResults&&e.search.maxResults<=0?i(w.configurationError("Search maxResults must be greater than 0.",{maxResults:e.search.maxResults})):void 0!==e.http?.timeout&&e.http.timeout<=0?i(w.configurationError("HTTP timeout must be greater than 0.",{timeout:e.http.timeout})):void 0!==e.http?.retries&&e.http.retries<0?i(w.configurationError("HTTP retries must be 0 or greater.",{retries:e.http.retries})):void 0!==e.auth?.expiresIn&&e.auth.expiresIn<=0?i(w.configurationError("Auth expiresIn must be greater than 0.",{expiresIn:e.auth.expiresIn})):r(void 0):i(w.configurationError("Invalid consumer credentials. Both consumerKey and consumerSecret are required.",{hasConsumerKey:Boolean(e.consumerKey?.trim()),hasConsumerSecret:Boolean(e.consumerSecret?.trim())})):i(w.configurationError("Invalid baseURL. Must be a valid URL.",{baseURL:e.baseURL}))}static getEnvironmentConfig(e){switch(e){case"development":return{debug:{enabled:!0,logLevel:"debug",performanceMonitoring:!0,errorReporting:!0,apiLogging:!0},http:{timeout:6e4,retries:1}};case"staging":return{debug:{enabled:!0,logLevel:"info",performanceMonitoring:!0,errorReporting:!0,apiLogging:!1},analytics:{enabled:!0,trackPageViews:!0,trackSearches:!0,trackConversions:!0}};case"production":return{debug:{enabled:!1,logLevel:"error",performanceMonitoring:!0,errorReporting:!0,apiLogging:!1},analytics:{enabled:!0,trackPageViews:!0,trackSearches:!0,trackConversions:!0},cache:{enabled:!0,ttl:3e5}};default:return{}}}static fromEnvironment(){try{if(!("undefined"!=typeof process&&process.env))return{};const e=process.env,t={};if(e.WOO_BASE_URL&&(t.baseURL=e.WOO_BASE_URL),e.WOO_CONSUMER_KEY&&(t.consumerKey=e.WOO_CONSUMER_KEY),e.WOO_CONSUMER_SECRET&&(t.consumerSecret=e.WOO_CONSUMER_SECRET),e.WOO_VERSION&&(t.version=e.WOO_VERSION),e.NODE_ENV){t.environment=e.NODE_ENV;const r=this.getEnvironmentConfig(e.NODE_ENV);Object.assign(t,r)}return t}catch{return{}}}static mergeConfigs(...e){const t={};for(const r of e)Object.assign(t,r),r.cache&&t.cache&&(t.cache={...t.cache,...r.cache}),r.auth&&t.auth&&(t.auth={...t.auth,...r.auth}),r.http&&t.http&&(t.http={...t.http,...r.http}),r.search&&t.search&&(t.search={...t.search,...r.search}),r.analytics&&t.analytics&&(t.analytics={...t.analytics,...r.analytics}),r.i18n&&t.i18n&&(t.i18n={...t.i18n,...r.i18n}),r.debug&&t.debug&&(t.debug={...t.debug,...r.debug});return t}}class D{constructor(e=50){this.cache=new Map,this.maxSize=1024*e*1024}async get(e){try{const t=this.cache.get(e);return t?Date.now()>t.timestamp+t.ttl?(this.cache.delete(e),r(null)):r(t.data):r(null)}catch(t){return i(w.cacheError("Failed to get from memory cache",t))}}async set(e,t,a){try{const s=this.estimateSize(t);if(s>this.maxSize)return i(w.cacheError("Value too large for cache"));await this.evictIfNeeded(s);const n={data:t,timestamp:Date.now(),ttl:a,key:e};return this.cache.set(e,n),r(void 0)}catch(s){return i(w.cacheError("Failed to set in memory cache",s))}}async delete(e){try{return this.cache.delete(e),r(void 0)}catch(t){return i(w.cacheError("Failed to delete from memory cache",t))}}async clear(){try{return this.cache.clear(),r(void 0)}catch(e){return i(w.cacheError("Failed to clear memory cache",e))}}async has(e){try{const t=await this.get(e);return t.success?r(null!==t.data):t}catch(t){return i(w.cacheError("Failed to check memory cache",t))}}async size(){try{return r(this.cache.size)}catch(e){return i(w.cacheError("Failed to get memory cache size",e))}}estimateSize(e){return 2*JSON.stringify(e).length}async evictIfNeeded(e){let t=0;const r=Array.from(this.cache.entries());for(const[,i]of r)t+=this.estimateSize(i.data);if(t+e>this.maxSize){const i=r.sort((e,t)=>e[1].timestamp-t[1].timestamp);for(const[r]of i)if(this.cache.delete(r),t-=this.estimateSize(this.cache.get(r)),t+e<=this.maxSize)break}}}class q{constructor(e="woo-cache",t=10){this.prefix=e,this.maxSize=1024*t*1024}async get(e){try{if("undefined"==typeof window||!window.localStorage)return r(null);const t=localStorage.getItem(`${this.prefix}:${e}`);if(!t)return r(null);const i=JSON.parse(t);return Date.now()>i.timestamp+i.ttl?(localStorage.removeItem(`${this.prefix}:${e}`),r(null)):r(i.data)}catch(t){return i(w.cacheError("Failed to get from localStorage",t))}}async set(e,t,a){try{if("undefined"==typeof window||!window.localStorage)return r(void 0);const n={data:t,timestamp:Date.now(),ttl:a,key:e},o=JSON.stringify(n);if(o.length>this.maxSize)return i(w.cacheError("Value too large for localStorage"));try{return localStorage.setItem(`${this.prefix}:${e}`,o),r(void 0)}catch(s){if(s instanceof Error&&"QuotaExceededError"===s.name)return await this.evictOldest(),localStorage.setItem(`${this.prefix}:${e}`,o),r(void 0);throw s}}catch(n){return i(w.cacheError("Failed to set in localStorage",n))}}async delete(e){try{return"undefined"!=typeof window&&window.localStorage?(localStorage.removeItem(`${this.prefix}:${e}`),r(void 0)):r(void 0)}catch(t){return i(w.cacheError("Failed to delete from localStorage",t))}}async clear(){try{if("undefined"==typeof window||!window.localStorage)return r(void 0);const e=Object.keys(localStorage);for(const t of e)t.startsWith(`${this.prefix}:`)&&localStorage.removeItem(t);return r(void 0)}catch(e){return i(w.cacheError("Failed to clear localStorage",e))}}async has(e){try{return"undefined"!=typeof window&&window.localStorage?r(null!==localStorage.getItem(`${this.prefix}:${e}`)):r(!1)}catch(t){return i(w.cacheError("Failed to check localStorage",t))}}async size(){try{if("undefined"==typeof window||!window.localStorage)return r(0);let e=0;const t=Object.keys(localStorage);for(const r of t)r.startsWith(`${this.prefix}:`)&&e++;return r(e)}catch(e){return i(w.cacheError("Failed to get localStorage size",e))}}async evictOldest(){const e=[],t=Object.keys(localStorage);for(const i of t)if(i.startsWith(`${this.prefix}:`))try{const t=localStorage.getItem(i);t&&e.push([i,JSON.parse(t)])}catch{}e.sort((e,t)=>e[1].timestamp-t[1].timestamp);const r=Math.ceil(.25*e.length);for(let i=0;i<r&&i<e.length;i++){const t=e[i];t&&t[0]&&localStorage.removeItem(t[0])}}}class ${constructor(e="woo-cache-db"){this.storeName="cache",this.version=1,this.db=null,this.dbName=e}async initDB(){try{return"undefined"!=typeof window&&window.indexedDB?this.db?r(this.db):new Promise(e=>{const t=indexedDB.open(this.dbName,this.version);t.onerror=()=>{e(i(w.cacheError("Failed to open IndexedDB")))},t.onsuccess=()=>{this.db=t.result,e(r(t.result))},t.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(this.storeName)||t.createObjectStore(this.storeName,{keyPath:"key"})}}):i(w.cacheError("IndexedDB not available"))}catch(e){return i(w.cacheError("Failed to initialize IndexedDB",e))}}async get(e){try{const t=await this.initDB();if(!t.success)return r(null);const a=t.data,s=a.transaction([this.storeName],"readonly").objectStore(this.storeName);return new Promise(t=>{const a=s.get(e);a.onerror=()=>{t(i(w.cacheError("Failed to get from IndexedDB")))},a.onsuccess=()=>{const i=a.result;if(i)return Date.now()>i.timestamp+i.ttl?(this.delete(e),void t(r(null))):void t(r(i.data));t(r(null))}})}catch(t){return i(w.cacheError("Failed to get from IndexedDB",t))}}async set(e,t,a){try{const s=await this.initDB();if(!s.success)return s;const n=s.data,o=n.transaction([this.storeName],"readwrite").objectStore(this.storeName),c={data:t,timestamp:Date.now(),ttl:a,key:e};return new Promise(e=>{const t=o.put(c);t.onerror=()=>{e(i(w.cacheError("Failed to set in IndexedDB")))},t.onsuccess=()=>{e(r(void 0))}})}catch(s){return i(w.cacheError("Failed to set in IndexedDB",s))}}async delete(e){try{const t=await this.initDB();if(!t.success)return t;const a=t.data,s=a.transaction([this.storeName],"readwrite").objectStore(this.storeName);return new Promise(t=>{const a=s.delete(e);a.onerror=()=>{t(i(w.cacheError("Failed to delete from IndexedDB")))},a.onsuccess=()=>{t(r(void 0))}})}catch(t){return i(w.cacheError("Failed to delete from IndexedDB",t))}}async clear(){try{const e=await this.initDB();if(!e.success)return e;const t=e.data,a=t.transaction([this.storeName],"readwrite").objectStore(this.storeName);return new Promise(e=>{const t=a.clear();t.onerror=()=>{e(i(w.cacheError("Failed to clear IndexedDB")))},t.onsuccess=()=>{e(r(void 0))}})}catch(e){return i(w.cacheError("Failed to clear IndexedDB",e))}}async has(e){const t=await this.get(e);return t.success?r(null!==t.data):t}async size(){try{const e=await this.initDB();if(!e.success)return r(0);const t=e.data,a=t.transaction([this.storeName],"readonly").objectStore(this.storeName);return new Promise(e=>{const t=a.count();t.onerror=()=>{e(i(w.cacheError("Failed to get IndexedDB size")))},t.onsuccess=()=>{e(r(t.result))}})}catch(e){return i(w.cacheError("Failed to get IndexedDB size",e))}}}class F{constructor(e){this.layers=new Map,this.config=e,this.initializeLayers()}initializeLayers(){this.layers.set("memory",new D(this.config.maxSize)),("localStorage"===this.config.storage||"sessionStorage"===this.config.storage)&&this.layers.set("localStorage",new q(this.config.prefix,this.config.maxSize)),"undefined"!=typeof window&&window.indexedDB&&this.layers.set("indexedDB",new $(this.config.prefix))}async get(e){if(!this.config.enabled)return r(null);for(const[t,r]of this.layers){const i=await r.get(e);if(i.success&&null!==i.data)return await this.promote(e,i.data,t),i}return r(null)}async set(e,t,a){if(!this.config.enabled)return r(void 0);const s=a??this.config.ttl,n=[];for(const r of this.layers.values()){const i=await r.set(e,t,s);i.success||n.push(i.error)}return n.length>0?i(w.cacheError("Failed to set in some cache layers",n)):r(void 0)}async delete(e){const t=[];for(const r of this.layers.values()){const i=await r.delete(e);i.success||t.push(i.error)}return t.length>0?i(w.cacheError("Failed to delete from some cache layers",t)):r(void 0)}async clear(){const e=[];for(const t of this.layers.values()){const r=await t.clear();r.success||e.push(r.error)}return e.length>0?i(w.cacheError("Failed to clear some cache layers",e)):r(void 0)}async has(e){if(!this.config.enabled)return r(!1);for(const t of this.layers.values()){const i=await t.has(e);if(i.success&&i.data)return r(!0)}return r(!1)}async getStats(){const e={};for(const[t,r]of this.layers){const i=await r.size();i.success&&(e[t]=i.data)}return r(e)}async promote(e,t,r){const i=["memory","localStorage","indexedDB"],a=i.indexOf(r);for(let s=0;s<a;s++){const r=i[s];if(r){const i=this.layers.get(r);i&&await i.set(e,t,this.config.ttl)}}}}class O{constructor(e,t){this.client=e,this.cache=t}async list(e={}){try{const i=this.validateListParams(e);if(!i.success)return i;const a=this.buildQueryParams(e),s=`products:list:${JSON.stringify(a)}`,n=await this.cache.get(s);if(n.success&&n.data)return r(n.data);const o=await this.client.get(`/products?${new URLSearchParams(a).toString()}`);if(!o.success)return o;const c=parseInt(o.data.headers["x-wp-total"]||"0"),d=parseInt(o.data.headers["x-wp-totalpages"]||"0"),u=[];for(const e of o.data.data)try{const t=b.parse(e);u.push(t)}catch(t){}const l={products:u,totalProducts:c,totalPages:d,currentPage:e.page||1,perPage:e.limit||10};return await this.cache.set(s,l),r(l)}catch(t){return i(w.apiError("Failed to list products",500,t))}}async get(e){try{if(!e||e<=0)return i(w.validationError("Invalid product ID"));const a=`products:single:${e}`,s=await this.cache.get(a);if(s.success&&s.data)return r(s.data);const n=await this.client.get(`/products/${e}`);if(!n.success)return 404===n.error.statusCode?i(w.productNotFoundError(e)):n;try{const e=b.parse(n.data.data);return await this.cache.set(a,e),r(e)}catch(t){return i(w.validationError("Invalid product data received from API",t))}}catch(t){return i(w.apiError("Failed to get product",500,t))}}async getBySlug(e){try{if(!e||0===e.trim().length)return i(w.validationError("Invalid product slug"));const t=await this.list({search:e,limit:1});if(!t.success)return t;const a=t.data.products.find(t=>t.slug===e);return a?r(a):i(w.productNotFoundError(e))}catch(t){return i(w.apiError("Failed to get product by slug",500,t))}}async getVariations(e,t={}){try{if(!e||e<=0)return i(w.validationError("Invalid product ID"));const a=this.buildVariationQueryParams(t),s=`products:${e}:variations:${JSON.stringify(a)}`,n=await this.cache.get(s);if(n.success&&n.data)return r(n.data);const o=await this.client.get(`/products/${e}/variations?${new URLSearchParams(a).toString()}`);return o.success?(await this.cache.set(s,o.data.data),r(o.data.data)):o}catch(a){return i(w.apiError("Failed to get product variations",500,a))}}async search(e,t={}){return e&&0!==e.trim().length?this.list({...t,search:e}):i(w.validationError("Search query cannot be empty"))}async getByCategory(e,t={}){return this.list({...t,category:e})}async getFeatured(e={}){return this.list({...e,featured:!0})}async getOnSale(e={}){return this.list({...e,onSale:!0})}validateListParams(e){return void 0!==e.page&&e.page<1?i(w.validationError("Page must be greater than 0")):void 0!==e.limit&&(e.limit<1||e.limit>100)?i(w.validationError("Limit must be between 1 and 100")):void 0!==e.minPrice&&e.minPrice<0?i(w.validationError("Min price cannot be negative")):void 0!==e.maxPrice&&e.maxPrice<0?i(w.validationError("Max price cannot be negative")):void 0!==e.minPrice&&void 0!==e.maxPrice&&e.minPrice>e.maxPrice?i(w.validationError("Min price cannot be greater than max price")):r(void 0)}buildQueryParams(e){const t={};return e.page&&(t.page=e.page.toString()),e.limit&&(t.per_page=e.limit.toString()),e.search&&(t.search=e.search),e.category&&(t.category=e.category.toString()),e.tag&&(t.tag=e.tag.toString()),e.status&&(t.status=e.status),void 0!==e.featured&&(t.featured=e.featured.toString()),void 0!==e.onSale&&(t.on_sale=e.onSale.toString()),e.orderby&&(t.orderby=e.orderby),e.order&&(t.order=e.order),e.offset&&(t.offset=e.offset.toString()),void 0!==e.inStock&&(t.stock_status=e.inStock?"instock":"outofstock"),void 0!==e.minPrice&&(t.min_price=e.minPrice.toString()),void 0!==e.maxPrice&&(t.max_price=e.maxPrice.toString()),e.include?.length&&(t.include=e.include.join(",")),e.exclude?.length&&(t.exclude=e.exclude.join(",")),e.parent?.length&&(t.parent=e.parent.join(",")),t}buildVariationQueryParams(e){const t={};return e.page&&(t.page=e.page.toString()),e.limit&&(t.per_page=e.limit.toString()),e.search&&(t.search=e.search),e.status&&(t.status=e.status),void 0!==e.onSale&&(t.on_sale=e.onSale.toString()),void 0!==e.inStock&&(t.stock_status=e.inStock?"instock":"outofstock"),void 0!==e.minPrice&&(t.min_price=e.minPrice.toString()),void 0!==e.maxPrice&&(t.max_price=e.maxPrice.toString()),t}}const M=e.z.object({key:e.z.string(),value:e.z.string(),displayKey:e.z.string().optional(),displayValue:e.z.string().optional()}),U=e.z.object({min:e.z.number().min(0),max:e.z.number().min(1),step:e.z.number().min(1)}),N=e.z.object({key:e.z.string(),productId:e.z.number().positive(),variationId:e.z.number().positive().optional(),quantity:e.z.number().positive(),name:e.z.string(),price:e.z.number().min(0),regularPrice:e.z.number().min(0),salePrice:e.z.number().min(0).optional(),totalPrice:e.z.number().min(0),total:e.z.number().min(0),sku:e.z.string().optional(),weight:e.z.number().min(0).optional(),dimensions:e.z.object({length:e.z.string(),width:e.z.string(),height:e.z.string()}).optional(),image:e.z.object({id:e.z.number().positive(),src:e.z.string().url(),alt:e.z.string()}).optional(),stockQuantity:e.z.number().min(0).optional(),stockStatus:e.z.enum(["instock","outofstock","onbackorder"]),backorders:e.z.enum(["no","notify","yes"]),quantityLimits:U.optional(),meta:e.z.array(M).optional(),attributes:e.z.record(e.z.string()).optional(),addedAt:e.z.date(),updatedAt:e.z.date()}),V=e.z.object({subtotal:e.z.number().min(0),subtotalTax:e.z.number().min(0),shippingTotal:e.z.number().min(0),shippingTax:e.z.number().min(0),discountTotal:e.z.number().min(0),discountTax:e.z.number().min(0),cartContentsTotal:e.z.number().min(0),cartContentsTax:e.z.number().min(0),feeTotal:e.z.number().min(0),feeTax:e.z.number().min(0),total:e.z.number().min(0),totalTax:e.z.number().min(0)}),L=e.z.object({code:e.z.string(),discountType:e.z.enum(["percent","fixed_cart","fixed_product"]),amount:e.z.number().min(0),description:e.z.string().optional(),freeShipping:e.z.boolean(),expiryDate:e.z.date().optional(),usageLimit:e.z.number().positive().optional(),usageCount:e.z.number().min(0),individualUse:e.z.boolean(),productIds:e.z.array(e.z.number().positive()).optional(),excludedProductIds:e.z.array(e.z.number().positive()).optional(),categoryIds:e.z.array(e.z.number().positive()).optional(),excludedCategoryIds:e.z.array(e.z.number().positive()).optional(),minimumAmount:e.z.number().min(0).optional(),maximumAmount:e.z.number().min(0).optional()}),B=e.z.object({items:e.z.array(N),itemCount:e.z.number().min(0),totals:V,appliedCoupons:e.z.array(L),shippingMethods:e.z.array(e.z.any()),chosenShippingMethods:e.z.array(e.z.string()),fees:e.z.array(e.z.any()),needsShipping:e.z.boolean(),needsPayment:e.z.boolean(),hasCalculatedShipping:e.z.boolean(),currency:e.z.string(),currencySymbol:e.z.string(),pricesIncludeTax:e.z.boolean(),taxDisplayMode:e.z.enum(["incl","excl"]),crossSells:e.z.array(e.z.number().positive()),isEmpty:e.z.boolean(),createdAt:e.z.date(),updatedAt:e.z.date(),expiresAt:e.z.date().optional(),customerId:e.z.number().positive().optional(),sessionId:e.z.string()}),j=e.z.object({productId:e.z.number().positive(),variationId:e.z.number().positive().optional(),quantity:e.z.number().positive(),attributes:e.z.record(e.z.string()).optional(),meta:e.z.array(M).optional(),replace:e.z.boolean().optional()});function H(e){try{return B.parse(e),!0}catch{return!1}}function K(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}e.z.object({productId:e.z.number().positive(),variationId:e.z.number().positive().optional(),quantity:e.z.number().positive(),attributes:e.z.record(e.z.string()).optional(),meta:e.z.array(M).optional()});class Q{constructor(e,t,r){this.syncStatus="idle",this.backgroundSyncTimer=void 0,this.isOnline=!0,this.syncQueue=[],this.eventHandlers=[],this.config=e,this.httpClient=t,this.deviceId=r??this.generateDeviceId(),this.setupNetworkMonitoring(),this.setupBackgroundSync()}getStatus(){return this.syncStatus}getLastSyncAt(){return this.lastSyncAt}addEventHandler(e){this.eventHandlers.push(e)}removeEventHandler(e){const t=this.eventHandlers.indexOf(e);t>-1&&this.eventHandlers.splice(t,1)}async syncCart(e,t){if(!this.config.enabled)return r({success:!0,status:"idle",conflicts:[],syncedAt:new Date,changes:{itemsAdded:0,itemsUpdated:0,itemsRemoved:0,couponsAdded:0,couponsRemoved:0}});if(!t.isAuthenticated||!t.userId)return i(w.cartError("User must be authenticated for cart synchronization",{context:"sync_cart"}));this.setSyncStatus("syncing"),this.notifyEventHandlers("onSyncStart");try{const i=await this.fetchServerCart(t.userId.toString());if(!i.success)return this.setSyncStatus("failed"),this.notifyEventHandlers("onSyncError",i.error),i;const a=i.data;if(!a){const i=await this.uploadCart(e,t);if(!i.success)return this.setSyncStatus("failed"),this.notifyEventHandlers("onSyncError",i.error),i;const a={success:!0,status:"synced",conflicts:[],mergedCart:e,syncedAt:new Date,changes:{itemsAdded:0,itemsUpdated:0,itemsRemoved:0,couponsAdded:0,couponsRemoved:0}};return this.setSyncStatus("synced"),this.lastSyncAt=new Date,this.notifyEventHandlers("onSyncComplete",a),r(a)}const s=await this.mergeCarts(e,a.cart);if(!s.success)return this.setSyncStatus("failed"),this.notifyEventHandlers("onSyncError",s.error),s;const{mergedCart:n,conflicts:o,changes:c}=s.data;if(o.length>0){this.setSyncStatus("conflict"),this.notifyEventHandlers("onConflictDetected",o);const t=await this.resolveConflicts(e,a.cart,o,this.config.conflictResolution);if(!t.success)return this.setSyncStatus("failed"),this.notifyEventHandlers("onSyncError",t.error),t}const d=await this.uploadCart(n,t);if(!d.success)return this.setSyncStatus("failed"),this.notifyEventHandlers("onSyncError",d.error),d;const u={success:!0,status:"synced",conflicts:o,mergedCart:n,syncedAt:new Date,changes:c};return this.setSyncStatus("synced"),this.lastSyncAt=new Date,this.notifyEventHandlers("onSyncComplete",u),r(u)}catch(a){const e=w.cartError("Cart synchronization failed",{error:a instanceof Error?a.message:"Unknown error"});return this.setSyncStatus("failed"),this.notifyEventHandlers("onSyncError",e),i(e)}}queueAction(e,t){if(!this.config.enabled||this.isOnline)return;const r={id:this.generateId(),action:e,data:t,timestamp:new Date,retryCount:0};this.syncQueue.push(r),this.syncQueue.length>this.config.offlineQueueSize&&this.syncQueue.shift()}async processQueue(e,t){if(!this.config.enabled||!t.isAuthenticated||0===this.syncQueue.length)return r(void 0);const i=[];for(const r of this.syncQueue)try{await this.processQueueItem(r,e,t)}catch(a){r.retryCount++,r.retryCount<this.config.maxRetries&&i.push(r)}return this.syncQueue=i,r(void 0)}enable(){this.config={...this.config,enabled:!0},this.setupBackgroundSync()}disable(){this.config={...this.config,enabled:!1},this.stopBackgroundSync()}destroy(){this.stopBackgroundSync(),this.eventHandlers.length=0,this.syncQueue.length=0}async fetchServerCart(e){try{const t=await this.httpClient.get(`/cart/sync/${e}`);return 404===t.status?r(null):t.success?r(t.data):i(w.cartError("Failed to fetch server cart",{status:t.status,error:t.error}))}catch(t){return i(w.cartError("Network error while fetching server cart",{error:t instanceof Error?t.message:"Unknown error"}))}}async uploadCart(e,t){if(!t.isAuthenticated||!t.userId)return i(w.cartError("User must be authenticated to upload cart",{context:"upload_cart"}));const a={cart:e,metadata:{deviceId:this.deviceId,lastSyncAt:new Date,syncVersion:1,userId:t.userId,sessionId:e.sessionId,source:"local"}};try{const e=await this.httpClient.put(`/cart/sync/${t.userId}`,a);return e.success?r(void 0):i(w.cartError("Failed to upload cart to server",{status:e.status,error:e.error}))}catch(s){return i(w.cartError("Network error while uploading cart",{error:s instanceof Error?s.message:"Unknown error"}))}}async mergeCarts(e,t){const a=[],s={itemsAdded:0,itemsUpdated:0,itemsRemoved:0,couponsAdded:0,couponsRemoved:0};try{const i=await this.mergeCartItems(e.items,t.items,this.config.strategy);if(!i.success)return i;const{mergedItems:n,itemConflicts:o}=i.data;a.push(...o),s.itemsAdded=n.filter(t=>!e.items.some(e=>e.key===t.key)).length,s.itemsUpdated=n.filter(t=>{const r=e.items.find(e=>e.key===t.key);return r&&r.quantity!==t.quantity}).length,s.itemsRemoved=e.items.filter(e=>!n.some(t=>t.key===e.key)).length;const c=this.mergeCoupons(e.appliedCoupons,t.appliedCoupons);a.push(...c.conflicts),s.couponsAdded=c.couponsAdded,s.couponsRemoved=c.couponsRemoved;return r({mergedCart:{...e,items:n,appliedCoupons:c.mergedCoupons,itemCount:n.reduce((e,t)=>e+t.quantity,0),updatedAt:new Date},conflicts:a,changes:s})}catch(n){return i(w.cartError("Failed to merge carts",{error:n instanceof Error?n.message:"Unknown error"}))}}async mergeCartItems(e,t,a){const s=[],n=[],o=new Set;try{for(const r of e){const e=t.find(e=>e.key===r.key);if(o.add(r.key),e)if(r.quantity===e.quantity)s.push(r);else{const t={type:"item_quantity",itemKey:r.key,localValue:r.quantity,serverValue:e.quantity,message:`Quantity mismatch for ${r.name}`,suggestion:this.getQuantityMergeSuggestion(a,r.quantity,e.quantity)};n.push(t);const i=this.resolveQuantityConflict(a,r.quantity,e.quantity);s.push({...r,quantity:i,totalPrice:r.price*i,updatedAt:new Date})}else s.push(r)}for(const e of t)o.has(e.key)||s.push(e);return r({mergedItems:s,itemConflicts:n})}catch(c){return i(w.cartError("Failed to merge cart items",{error:c instanceof Error?c.message:"Unknown error"}))}}mergeCoupons(e,t){const r=[],i=new Set;let a=0,s=0;for(const n of e)i.add(n.code),r.push(n);for(const n of t)i.has(n.code)||(r.push(n),a++);return s=t.filter(t=>!e.some(e=>e.code===t.code)).length,{mergedCoupons:r,conflicts:[],couponsAdded:a,couponsRemoved:s}}async resolveConflicts(e,t,i,a){return r(e)}resolveQuantityConflict(e,t,r){switch(e){case"local_wins":return t;case"server_wins":return r;case"merge_quantities":return t+r;default:return Math.max(t,r)}}getQuantityMergeSuggestion(e,t,r){switch(e){case"local_wins":return`Keep local quantity: ${t}`;case"server_wins":return`Use server quantity: ${r}`;case"merge_quantities":return`Add quantities: ${t+r}`;default:return`Use higher quantity: ${Math.max(t,r)}`}}async processQueueItem(e,t,r){console.warn("Cart sync queue processing not yet implemented for action:",e.action)}setSyncStatus(e){this.syncStatus=e}notifyEventHandlers(e,...t){for(const i of this.eventHandlers)try{switch(e){case"onSyncStart":i.onSyncStart();break;case"onSyncComplete":i.onSyncComplete(t[0]);break;case"onSyncError":i.onSyncError(t[0]);break;case"onConflictDetected":i.onConflictDetected(t[0])}}catch(r){console.error("Error in cart sync event handler:",r)}}setupNetworkMonitoring(){"undefined"!=typeof navigator&&"onLine"in navigator&&(this.isOnline=navigator.onLine,window.addEventListener("online",()=>{this.isOnline=!0}),window.addEventListener("offline",()=>{this.isOnline=!1}))}setupBackgroundSync(){this.config.enabled&&this.config.backgroundSync&&(this.stopBackgroundSync(),this.backgroundSyncTimer=setInterval(()=>{},this.config.syncIntervalMs))}stopBackgroundSync(){this.backgroundSyncTimer&&(clearInterval(this.backgroundSyncTimer),this.backgroundSyncTimer=void 0)}generateDeviceId(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"device-"+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}generateId(){return Date.now().toString(36)+Math.random().toString(36).substring(2)}}class W{constructor(e){this.config=e}async save(e){try{const t=JSON.stringify(e,(e,t)=>t instanceof Date?t.toISOString():t);switch(this.config.strategy){case"localStorage":"undefined"!=typeof localStorage&&localStorage.setItem(this.getStorageKey(),t);break;case"sessionStorage":"undefined"!=typeof sessionStorage&&sessionStorage.setItem(this.getStorageKey(),t);break;case"indexedDB":return this.saveToIndexedDB(e);case"server":return this.saveToServer(e);case"none":break;default:return i(w.configurationError("Invalid persistence strategy"))}return r(void 0)}catch(t){return i(w.persistenceError("Failed to save cart",t))}}async load(){try{let e=null;switch(this.config.strategy){case"localStorage":"undefined"!=typeof localStorage&&(e=localStorage.getItem(this.getStorageKey()));break;case"sessionStorage":"undefined"!=typeof sessionStorage&&(e=sessionStorage.getItem(this.getStorageKey()));break;case"indexedDB":return this.loadFromIndexedDB();case"server":return this.loadFromServer();case"none":return r(null);default:return i(w.configurationError("Invalid persistence strategy"))}if(!e)return r(null);const t=JSON.parse(e,(e,t)=>"string"==typeof t&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(t)?new Date(t):t);return H(t)?r(t):i(w.validationError("Invalid cart data in storage"))}catch(e){return i(w.persistenceError("Failed to load cart",e))}}async clear(){try{switch(this.config.strategy){case"localStorage":"undefined"!=typeof localStorage&&localStorage.removeItem(this.getStorageKey());break;case"sessionStorage":"undefined"!=typeof sessionStorage&&sessionStorage.removeItem(this.getStorageKey());break;case"indexedDB":return this.clearFromIndexedDB();case"server":return this.clearFromServer();case"none":break;default:return i(w.configurationError("Invalid persistence strategy"))}return r(void 0)}catch(e){return i(w.persistenceError("Failed to clear cart",e))}}getStorageKey(){return this.config.key||"woo-headless-cart"}async saveToIndexedDB(e){try{if("undefined"==typeof window||!window.indexedDB)return i(w.persistenceError("IndexedDB not available"));const t=await this.openIndexedDB(),a=t.transaction(["carts"],"readwrite").objectStore("carts");return await new Promise((t,r)=>{const i=a.put({id:this.getStorageKey(),cart:e,timestamp:Date.now(),expiresAt:this.config.expirationDays?Date.now()+24*this.config.expirationDays*60*60*1e3:null});i.onsuccess=()=>t(),i.onerror=()=>r(i.error)}),t.close(),r(void 0)}catch(t){return i(w.persistenceError("Failed to save cart to IndexedDB",t))}}async loadFromIndexedDB(){try{if("undefined"==typeof window||!window.indexedDB)return r(null);const e=await this.openIndexedDB(),t=e.transaction(["carts"],"readonly").objectStore("carts"),a=await new Promise((e,r)=>{const i=t.get(this.getStorageKey());i.onsuccess=()=>e(i.result),i.onerror=()=>r(i.error)});return e.close(),a?a.expiresAt&&Date.now()>a.expiresAt?(await this.clearFromIndexedDB(),r(null)):H(a.cart)?r(a.cart):i(w.validationError("Invalid cart data in IndexedDB")):r(null)}catch(e){return i(w.persistenceError("Failed to load cart from IndexedDB",e))}}async clearFromIndexedDB(){try{if("undefined"==typeof window||!window.indexedDB)return r(void 0);const e=await this.openIndexedDB(),t=e.transaction(["carts"],"readwrite").objectStore("carts");return await new Promise((e,r)=>{const i=t.delete(this.getStorageKey());i.onsuccess=()=>e(),i.onerror=()=>r(i.error)}),e.close(),r(void 0)}catch(e){return i(w.persistenceError("Failed to clear cart from IndexedDB",e))}}async openIndexedDB(){return new Promise((e,t)=>{const r=indexedDB.open("WooHeadlessCart",1);r.onerror=()=>t(r.error),r.onsuccess=()=>e(r.result),r.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains("carts")){const e=t.createObjectStore("carts",{keyPath:"id"});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("expiresAt","expiresAt",{unique:!1})}}})}async saveToServer(e){try{if(!this.config.syncToServer)return i(w.configurationError("Server sync is disabled","Enable syncToServer in cart persistence config"));const t={sessionId:e.sessionId,customerId:e.customerId,items:e.items,totals:e.totals,appliedCoupons:e.appliedCoupons,updatedAt:e.updatedAt.toISOString(),expiresAt:e.expiresAt?.toISOString()};return console.warn("Server-side cart persistence requires custom implementation"),console.log("Cart data to sync:",t),r(void 0)}catch(t){return i(w.persistenceError("Failed to save cart to server",t))}}async loadFromServer(){try{return this.config.syncToServer?(console.warn("Server-side cart persistence requires custom implementation"),r(null)):r(null)}catch(e){return i(w.persistenceError("Failed to load cart from server",e))}}async clearFromServer(){try{return this.config.syncToServer?(console.warn("Server-side cart persistence requires custom implementation"),r(void 0)):r(void 0)}catch(e){return i(w.persistenceError("Failed to clear cart from server",e))}}}class G{constructor(e){this.config=e}calculate(e,t=[],r=[],i=[],a){const s=this.calculateSubtotal(e),n=this.calculateSubtotalTax(e,a),{discountTotal:o,discountTax:c}=this.calculateDiscounts(e,t,a),d=Math.max(0,s-o),u=Math.max(0,n-c),{shippingTotal:l,shippingTax:h}=this.calculateShipping(r,d,a),{feeTotal:p,feeTax:m}=this.calculateFees(i,d,a),g=u+h+m,y=this.calculateFinalTotal(d,l,p,g);return{subtotal:this.roundTotal(s),subtotalTax:this.roundTotal(n),tax:this.roundTotal(g),shipping:this.roundTotal(l),shippingTotal:this.roundTotal(l),shippingTax:this.roundTotal(h),discount:this.roundTotal(o),discountTotal:this.roundTotal(o),discountTax:this.roundTotal(c),fees:this.roundTotal(p),feeTotal:this.roundTotal(p),feeTax:this.roundTotal(m),total:this.roundTotal(y),totalTax:this.roundTotal(g),cartContentsTotal:this.roundTotal(d),cartContentsTax:this.roundTotal(u)}}calculateSubtotal(e){return e.reduce((e,t)=>this.config.taxCalculation.pricesIncludeTax?e+t.totalPrice:e+t.regularPrice*t.quantity,0)}calculateSubtotalTax(e,t){if(!this.config.taxCalculation.enabled)return 0;const r=t?.taxRate||this.getDefaultTaxRate(t?.country,t?.state);return e.reduce((e,t)=>{const i=t.regularPrice*t.quantity;return this.config.taxCalculation.pricesIncludeTax?e+i*r/(1+r):e+i*r},0)}calculateDiscounts(e,t,r){let i=0,a=0;for(const s of t){const t=this.calculateSingleCouponDiscount(e,s);if(i+=t,this.config.taxCalculation.enabled&&!this.config.taxCalculation.pricesIncludeTax){a+=t*(r?.taxRate||this.getDefaultTaxRate(r?.country,r?.state))}}return{discountTotal:i,discountTax:a}}calculateSingleCouponDiscount(e,t){const r=e.filter(e=>this.couponAppliesToItem(e,t));if(0===r.length)return 0;const i=r.reduce((e,t)=>e+t.totalPrice,0);switch(t.discountType){case"fixed_cart":return Math.min(t.amount,i);case"percent":const e=i*(t.amount/100);return t.maximumAmount?Math.min(e,t.maximumAmount):e;case"fixed_product":return Math.min(r.reduce((e,r)=>e+t.amount*r.quantity,0),i);default:return 0}}couponAppliesToItem(e,t){return!(t.productIds&&t.productIds.length>0&&!t.productIds.includes(e.productId))&&(!t.excludedProductIds||!t.excludedProductIds.includes(e.productId))}calculateShipping(e,t,r){if(!this.config.enableShipping||0===e.length)return{shippingTotal:0,shippingTax:0};const i=e[0];if(!i)return{shippingTotal:0,shippingTax:0};const a=i.cost;let s=0;if(this.config.taxCalculation.enabled&&i.taxable){const e=r?.taxRate||this.getDefaultTaxRate(r?.country,r?.state);s=i.taxes?.reduce((e,t)=>e+t.total,0)||a*e}return{shippingTotal:a,shippingTax:s}}calculateFees(e,t,r){if(!this.config.enableFees||0===e.length)return{feeTotal:0,feeTax:0};const i=e.reduce((e,t)=>e+t.amount,0);let a=0;if(this.config.taxCalculation.enabled){const t=r?.taxRate||this.getDefaultTaxRate(r?.country,r?.state);a=e.reduce((e,r)=>r.taxable?e+(r.taxes?.reduce((e,t)=>e+t.total,0)||r.amount*t):e,0)}return{feeTotal:i,feeTax:a}}calculateFinalTotal(e,t,r,i){return this.config.taxCalculation.pricesIncludeTax?e+t+r:e+t+r+i}getDefaultTaxRate(e,t){return{US:.0875,CA:.13,GB:.2,DE:.19,FR:.2,AU:.1}[e||"US"]||.1}roundTotal(e){return this.config.taxCalculation.roundAtSubtotal?Math.round(100*e)/100:Math.round(1e4*e)/1e4}}class J{constructor(e,t,r){this.currentCart=null,this.authContext=null,this.client=e,this.cache=t,this.config=r,this.persistence=new W(r.persistence),this.calculator=new G(r),this.syncManager=new Q(r.sync,e)}async getCart(){try{if(!this.currentCart){const e=await this.persistence.load();if(!e.success)return e;this.currentCart=e.data||this.createEmptyCart()}return r(this.currentCart)}catch(e){return i(w.cartError("Failed to get cart",e))}}async addItem(e){try{const t=this.validateAddItemRequest(e);if(!t.success)return t;const a=await this.getCart();if(!a.success)return a;const s=a.data,n=await this.fetchProductData(e);if(!n.success)return n;const o=n.data;if(this.config.validateStock){const t=this.validateStock(o,e.quantity);if(!t.success)return t}const c=this.generateCartItemKey(e),d=s.items.findIndex(e=>e.key===c);let u;if(d>=0)if(e.replace)u=[...s.items],u[d]=this.createCartItem(o,e,c);else{const t=s.items[d];if(!t)return i(w.cartError("Cart item not found"));const r=t.quantity+e.quantity;if(r>this.config.maxQuantityPerItem)return i(w.validationError(`Maximum quantity per item is ${this.config.maxQuantityPerItem}`));const a={key:t.key,productId:t.productId,variationId:t.variationId,quantity:r,name:t.name,price:t.price,regularPrice:t.regularPrice,salePrice:t.salePrice,totalPrice:t.price*r,total:t.price*r,sku:t.sku,weight:t.weight,...t.dimensions&&{dimensions:t.dimensions},...t.image&&{image:t.image},stockQuantity:t.stockQuantity,stockStatus:t.stockStatus,backorders:t.backorders,...t.quantityLimits&&{quantityLimits:t.quantityLimits},...t.meta&&{meta:t.meta},...t.attributes&&{attributes:t.attributes},addedAt:t.addedAt,updatedAt:new Date,backordersAllowed:t.backordersAllowed,soldIndividually:t.soldIndividually,downloadable:t.downloadable,virtual:t.virtual};u=[...s.items],u[d]=a}else{if(s.items.length>=this.config.maxItems)return i(w.validationError(`Maximum ${this.config.maxItems} items allowed in cart`));const t=this.createCartItem(o,e,c);u=[...s.items,t]}const l=this.updateCartWithItems(s,u),h=await this.persistence.save(l);return h.success?(this.currentCart=l,r(l)):h}catch(t){return i(w.cartError("Failed to add item to cart",t))}}async updateItem(e,t){try{if(t<=0){const t=await this.removeItem(e);return t.success?this.getCart():t}const a=await this.getCart();if(!a.success)return a;const s=a.data,n=s.items.findIndex(t=>t.key===e);if(-1===n)return i(w.cartError("Item not found in cart",{itemKey:e}));if(t>this.config.maxQuantityPerItem)return i(w.validationError(`Maximum quantity per item is ${this.config.maxQuantityPerItem}`));const o=s.items[n];if(!o)return i(w.cartError("Cart item not found"));if(this.config.validateStock){if("outofstock"===o.stockStatus)return i(w.validationError("Product is out of stock"));if(void 0!==o.stockQuantity&&t>o.stockQuantity)return i(w.validationError(`Only ${o.stockQuantity} items available in stock`))}const c={key:o.key,productId:o.productId,variationId:o.variationId,quantity:t,name:o.name,price:o.price,regularPrice:o.regularPrice,salePrice:o.salePrice,totalPrice:o.price*t,total:o.price*t,sku:o.sku,weight:o.weight,...o.dimensions&&{dimensions:o.dimensions},...o.image&&{image:o.image},stockQuantity:o.stockQuantity,stockStatus:o.stockStatus,backorders:o.backorders,...o.quantityLimits&&{quantityLimits:o.quantityLimits},...o.meta&&{meta:o.meta},...o.attributes&&{attributes:o.attributes},addedAt:o.addedAt,updatedAt:new Date,backordersAllowed:o.backordersAllowed,soldIndividually:o.soldIndividually,downloadable:o.downloadable,virtual:o.virtual},d=[...s.items];d[n]=c;const u=this.updateCartWithItems(s,d),l=await this.persistence.save(u);return l.success?(this.currentCart=u,r(u)):l}catch(a){return i(w.cartError("Failed to update cart item",a))}}async removeItem(e){try{const t=await this.getCart();if(s(t))return t;const a=n(t),o=a.items.findIndex(t=>t.key===e);if(-1===o)return i(w.validationError("Cart item not found"));const c=a.items.filter((e,t)=>t!==o),d=this.calculator.calculate(c,a.appliedCoupons,a.shippingMethods,a.fees),u={...a,items:c,totals:d,isEmpty:0===c.length,itemCount:c.reduce((e,t)=>e+t.quantity,0),updatedAt:new Date},l=await this.persistence.save(u);return l.success?(this.currentCart=u,r(void 0)):l}catch(t){return i(w.networkError(t instanceof Error?t.message:"Failed to remove cart item"))}}async clearCart(){try{const e=this.createEmptyCart(),t=await this.persistence.save(e);return t.success?(this.currentCart=e,r(e)):t}catch(e){return i(w.cartError("Failed to clear cart",e))}}async validateCart(){try{const e=await this.getCart();if(!e.success)return e;const t=e.data,i=[],a=[];for(const r of t.items)await this.validateCartItem(r,i,a);const s=[],n=[];await this.validateCartConstraints(t,s,n),i.push(...s),n.forEach(e=>a.push({itemKey:e.itemKey,code:"PRICE_CHANGED",message:e.message,...e.details&&{details:e.details}}));const o=[],c=[];await this.validateAppliedCoupons(t,o,c),c.forEach(e=>a.push({itemKey:e.itemKey,code:"PRICE_CHANGED",message:e.message,details:e.details})),o.forEach(e=>i.push({itemKey:e.itemKey,code:"INVALID_QUANTITY",message:e.message}));const d=[];return await this.validateCartTotals(t,d),d.forEach(e=>a.push({itemKey:e.itemKey,code:"PRICE_CHANGED",message:e.message,details:e.details})),r({isValid:0===i.length,errors:i,warnings:a})}catch(e){return i(w.cartError("Cart validation failed",e))}}async validateCartItem(e,t,r){try{const i=await this.fetchProductData({productId:e.productId,variationId:e.variationId,quantity:e.quantity});if(s(i))return void t.push({itemKey:e.key,code:"PRODUCT_NOT_FOUND",message:`Product with ID ${e.productId} not found`,currentStock:0,requestedQuantity:e.quantity});const a=n(i);if("publish"!==a.status)return void t.push({itemKey:e.key,code:"PRODUCT_NOT_FOUND",message:`Product ${e.name} is no longer available`});const o=[],c=[];await this.validateItemStock(e,a,o,c),o.forEach(e=>t.push({...e,code:e.code})),c.forEach(e=>r.push({...e,code:e.code}));const d=[],u=[];this.validateItemQuantityLimits(e,a,d,u),d.forEach(e=>t.push({...e,code:e.code}));const l=[];if(this.validateItemPriceChanges(e,a,l),l.forEach(e=>r.push({...e,code:e.code})),e.variationId&&"variable"===a.type){const r=[];await this.validateProductVariation(e,a,r),r.forEach(e=>t.push({...e,code:e.code}))}}catch(i){r.push({itemKey:e.key,code:"LOW_STOCK",message:`Could not validate item: ${i instanceof Error?i.message:"Unknown error"}`,details:{error:i}})}}async validateItemStock(e,t,r,i){if("outofstock"!==t.stock_status){if(t.manage_stock&&null!==t.stock_quantity){const a=t.stock_quantity;if(null!=a&&e.quantity>a)return void(0===a?r.push({itemKey:e.key,code:"OUT_OF_STOCK",message:`${e.name} is out of stock`,currentStock:a,requestedQuantity:e.quantity}):r.push({itemKey:e.key,code:"INSUFFICIENT_STOCK",message:`Only ${a} units of ${e.name} available, but ${e.quantity} requested`,currentStock:a??0,requestedQuantity:e.quantity}));const s=Math.max(5,Math.ceil(.1*(a??0)));null!=a&&a<=s&&a>e.quantity&&i.push({itemKey:e.key,code:"LOW_STOCK",message:`Only ${a??0} units of ${e.name} remaining`,details:{availableStock:a??0,threshold:s}})}"onbackorder"===t.stock_status&&("no"===t.backorders?r.push({itemKey:e.key,code:"OUT_OF_STOCK",message:`${e.name} is temporarily unavailable`,currentStock:0,requestedQuantity:e.quantity}):i.push({itemKey:e.key,code:"BACKORDER",message:`${e.name} is on backorder and may take longer to ship`,details:{backorderNotify:"notify"===t.backorders}}))}else r.push({itemKey:e.key,code:"OUT_OF_STOCK",message:`${e.name} is currently out of stock`,currentStock:0,requestedQuantity:e.quantity})}validateItemQuantityLimits(e,t,r,i){if(e.quantityLimits){const{min:t,max:i,step:a}=e.quantityLimits;e.quantity<t&&r.push({itemKey:e.key,code:"INVALID_QUANTITY",message:`Minimum quantity for ${e.name} is ${t}`,requestedQuantity:e.quantity}),e.quantity>i&&r.push({itemKey:e.key,code:"INVALID_QUANTITY",message:`Maximum quantity for ${e.name} is ${i}`,requestedQuantity:e.quantity}),(e.quantity-t)%a!==0&&r.push({itemKey:e.key,code:"INVALID_QUANTITY",message:`${e.name} must be ordered in multiples of ${a}`,requestedQuantity:e.quantity})}e.quantity>this.config.maxQuantityPerItem&&r.push({itemKey:e.key,code:"INVALID_QUANTITY",message:`Maximum quantity per item is ${this.config.maxQuantityPerItem}`,requestedQuantity:e.quantity})}validateItemPriceChanges(e,t,r){const i=parseFloat(t.regular_price),a=t.sale_price?parseFloat(t.sale_price):void 0;Math.abs(e.regularPrice-i)>.01&&r.push({itemKey:e.key,code:"PRICE_CHANGED",message:`Price for ${e.name} has changed from $${e.regularPrice.toFixed(2)} to $${i.toFixed(2)}`,details:{previousPrice:e.regularPrice,currentPrice:i,priceIncrease:i>e.regularPrice}});const s=e.salePrice||null;(null!==s&&void 0===a||null===s&&void 0!==a||null!==s&&void 0!==a&&Math.abs(s-a)>.01)&&r.push({itemKey:e.key,code:"PRICE_CHANGED",message:`Sale price for ${e.name} has changed`,details:{previousSalePrice:s,currentSalePrice:a}})}async validateProductVariation(e,t,r){try{if(!e.variationId)return void r.push({itemKey:e.key,code:"VARIATION_NOT_FOUND",message:`Product variation is required for ${e.name}`});if(e.attributes)for(const[t,i]of Object.entries(e.attributes))i&&""!==i.trim()||r.push({itemKey:e.key,code:"VARIATION_NOT_FOUND",message:`Invalid variation attribute ${t} for ${e.name}`})}catch(i){r.push({itemKey:e.key,code:"VARIATION_NOT_FOUND",message:`Could not validate product variation for ${e.name}`})}}async validateCartConstraints(e,t,r){e.items.length>this.config.maxItems&&t.push({itemKey:"",code:"INVALID_QUANTITY",message:`Cart cannot contain more than ${this.config.maxItems} items`});const i=e.items.reduce((e,t)=>e+t.quantity,0),a=this.config.maxItems*this.config.maxQuantityPerItem;i>a&&r.push({itemKey:"",code:"HIGH_QUANTITY",message:`Cart contains ${i} items, which may affect performance`,details:{totalQuantity:i,maxRecommended:a}}),0===e.items.length&&r.push({itemKey:"",code:"EMPTY_CART",message:"Cart is empty"})}async validateAppliedCoupons(e,t,r){for(const a of e.appliedCoupons)try{if(a.expiryDate&&a.expiryDate<new Date){t.push({itemKey:"",code:"COUPON_EXPIRED",message:`Coupon ${a.code} has expired`});continue}if(a.usageLimit&&a.usageCount>=a.usageLimit){t.push({itemKey:"",code:"COUPON_USAGE_LIMIT_EXCEEDED",message:`Coupon ${a.code} has reached its usage limit`});continue}if(a.minimumAmount&&e.totals.subtotal<a.minimumAmount){t.push({itemKey:"",code:"COUPON_MINIMUM_NOT_MET",message:`Coupon ${a.code} requires a minimum order of $${a.minimumAmount.toFixed(2)}`});continue}a.maximumAmount&&e.totals.subtotal>a.maximumAmount&&r.push({itemKey:"",code:"COUPON_VALIDATION_ERROR",message:`Coupon ${a.code} is only valid for orders up to $${a.maximumAmount.toFixed(2)}`,details:{couponCode:a.code,maximumAmount:a.maximumAmount}}),a.individualUse&&e.appliedCoupons.length>1&&t.push({itemKey:"",code:"COUPON_INDIVIDUAL_USE",message:`Coupon ${a.code} cannot be combined with other coupons`})}catch(i){r.push({itemKey:"",code:"COUPON_VALIDATION_ERROR",message:`Could not validate coupon ${a.code}`,details:{couponCode:a.code,error:i}})}}async validateCartTotals(e,t){try{const r=this.calculator.calculate(e.items,e.appliedCoupons,e.shippingMethods,e.fees),i=.01;Math.abs(e.totals.total-r.total)>i&&t.push({itemKey:"",code:"TOTALS_MISMATCH",message:"Cart totals may be outdated and need recalculation",details:{storedTotal:e.totals.total,calculatedTotal:r.total,difference:Math.abs(e.totals.total-r.total)}})}catch(r){t.push({itemKey:"",code:"TOTALS_VALIDATION_ERROR",message:"Could not validate cart totals",details:{error:r}})}}async applyCoupon(e){try{const t=await this.getCart();if(s(t))return t;const a=n(t);if(a.appliedCoupons.some(t=>t.code===e))return i(w.validationError("Coupon is already applied"));const o=await this.validateCoupon(e);if(s(o))return o;const c=n(o);if(!c.valid)return i(w.validationError(c.reason||"Invalid coupon"));const d={code:c.coupon.code,amount:parseFloat(c.coupon.amount||"0"),description:c.coupon.description||"",discountType:c.coupon.discount_type||"fixed_cart",freeShipping:c.coupon.free_shipping||!1,minimumAmount:c.coupon.minimum_amount?parseFloat(c.coupon.minimum_amount):void 0,maximumAmount:c.coupon.maximum_amount?parseFloat(c.coupon.maximum_amount):void 0,usageCount:c.coupon.usage_count||0,usageLimit:c.coupon.usage_limit||void 0,...c.coupon.date_expires&&{expiryDate:new Date(c.coupon.date_expires)},individualUse:c.coupon.individual_use||!1},u=[...a.appliedCoupons,d],l=this.calculator.calculate(a.items,u,a.shippingMethods,a.fees),h={...a,appliedCoupons:u,totals:l,updatedAt:new Date},p=await this.persistence.save(h);return p.success?(this.currentCart=h,r(h)):p}catch(t){return i(w.networkError(t instanceof Error?t.message:"Failed to apply coupon"))}}async removeCoupon(e){try{if(!this.config.enableCoupons)return i(w.configurationError("Coupons are disabled"));if(!e||""===e.trim())return i(w.validationError("Coupon code is required"));const t=await this.getCart();if(!t.success)return t;const a=t.data,s=e.trim().toUpperCase();if(!a.appliedCoupons.some(e=>e.code===s))return i(w.validationError(`Coupon ${s} is not applied to this cart`));const n=a.appliedCoupons.filter(e=>e.code!==s),o=this.calculator.calculate(a.items,n,a.shippingMethods,a.fees),c={...a,appliedCoupons:n,totals:o,updatedAt:new Date},d=await this.persistence.save(c);return d.success?(this.currentCart=c,r(c)):d}catch(t){return i(w.cartError("Failed to remove coupon",t))}}async getAvailableCoupons(){try{if(!this.config.enableCoupons)return i(w.configurationError("Coupons are disabled"));const e=await this.getCart();if(!e.success)return e;const t=e.data,a=await this.client.get("/coupons",{status:"publish",per_page:"100",orderby:"date",order:"desc"});if(!a.success)return a;const s=[];for(const r of a.data.data){await this.isCouponEligibleForCart(r,t)&&s.push(r)}return r(s)}catch(e){return i(w.cartError("Failed to get available coupons",e))}}async validateCoupon(e){try{if(!this.config.enableCoupons)return r({valid:!1,reason:"Coupons are disabled"});if(!e||""===e.trim())return r({valid:!1,reason:"Coupon code is required"});const t=e.trim().toUpperCase(),i=await this.fetchCouponData(t);if(!i.success)return r({valid:!1,reason:"Coupon not found"});const a=i.data,s=await this.getCart();if(!s.success)return s;const n=s.data,o=await this.validateCouponEligibility(a,n);return o.success?r({valid:!0,coupon:a}):r({valid:!1,coupon:a,reason:o.error.message})}catch(t){return i(w.cartError("Failed to validate coupon",t))}}async fetchCouponData(e){try{const t=`coupons:${e}`,a=await this.cache.get(t);if(a.success&&a.data)return r(a.data);const s=await this.client.get("/coupons",{code:e,status:"publish"});if(!s.success)return i(w.validationError("Coupon not found"));const n=s.data.data;if(!n||0===n.length)return i(w.validationError("Coupon not found"));const o=n[0];return o?(await this.cache.set(t,o,300),r(o)):i(w.validationError(`Coupon ${e} not found`))}catch(t){return i(w.cartError("Failed to fetch coupon data",t))}}async validateCouponEligibility(e,t){try{if(e.date_expires){if(new Date(e.date_expires)<new Date)return i(w.validationError(`Coupon ${e.code} has expired`))}if(e.usage_limit&&e.usage_count>=e.usage_limit)return i(w.validationError(`Coupon ${e.code} has reached its usage limit`));if(e.minimum_amount){const r=parseFloat(e.minimum_amount);if(t.totals.subtotal<r)return i(w.validationError(`Coupon ${e.code} requires a minimum order of $${r.toFixed(2)}`))}if(e.maximum_amount){const r=parseFloat(e.maximum_amount);if(t.totals.subtotal>r)return i(w.validationError(`Coupon ${e.code} is only valid for orders up to $${r.toFixed(2)}`))}if(e.product_ids&&e.product_ids.length>0){if(!t.items.some(t=>e.product_ids.includes(t.productId)))return i(w.validationError(`Coupon ${e.code} is not valid for the products in your cart`))}if(e.excluded_product_ids&&e.excluded_product_ids.length>0){if(t.items.some(t=>e.excluded_product_ids.includes(t.productId)))return i(w.validationError(`Coupon ${e.code} cannot be used with some products in your cart`))}return e.individual_use&&t.appliedCoupons.length>0?i(w.validationError(`Coupon ${e.code} cannot be combined with other coupons`)):r(void 0)}catch(a){return i(w.cartError("Failed to validate coupon eligibility",a))}}async isCouponEligibleForCart(e,t){try{return(await this.validateCouponEligibility(e,t)).success}catch{return!1}}validateAddItemRequest(e){try{return j.parse(e),r(void 0)}catch(t){return i(w.validationError("Invalid add item request",t))}}async fetchProductData(e){const t=`products:single:${e.productId}`,a=await this.cache.get(t);if(a.success&&a.data)return r(a.data);const s=await this.client.get(`/products/${e.productId}`);return s.success?(await this.cache.set(t,s.data.data),r(s.data.data)):404===s.error.statusCode?i(w.productNotFoundError(e.productId)):s}validateStock(e,t){return"outofstock"===e.stock_status?i(w.validationError("Product is out of stock")):null!==e.stock_quantity&&void 0!==e.stock_quantity&&t>e.stock_quantity?i(w.validationError(`Only ${e.stock_quantity} items available in stock`)):r(void 0)}generateCartItemKey(e){let t=`${e.productId}`;if(e.variationId&&(t+=`-${e.variationId}`),e.attributes){t+=`-${Object.keys(e.attributes).sort().map(t=>`${t}:${e.attributes[t]}`).join("|")}`}return t}createCartItem(e,t,r){const i=parseFloat(e.price)||0,a=parseFloat(e.regular_price)||0,s=e.sale_price?parseFloat(e.sale_price):void 0,n=i*t.quantity;return{key:r,productId:e.id,variationId:t.variationId,quantity:t.quantity,name:e.name,price:i,regularPrice:a,salePrice:s,totalPrice:n,total:n,sku:e.sku||void 0,weight:e.weight?parseFloat(e.weight):void 0,stockQuantity:e.stock_quantity||void 0,stockStatus:e.stock_status,backorders:e.backorders||"no",backordersAllowed:e.backorders_allowed||!1,soldIndividually:e.sold_individually||!1,downloadable:e.downloadable||!1,virtual:e.virtual||!1,meta:[],addedAt:new Date,updatedAt:new Date}}createEmptyCart(){const e=new Date,t=K();return{items:[],itemCount:0,totals:this.calculator.calculate([]),appliedCoupons:[],shippingMethods:[],chosenShippingMethods:[],fees:[],needsShipping:!1,needsPayment:!1,hasCalculatedShipping:!1,currency:"USD",currencySymbol:"$",pricesIncludeTax:this.config.taxCalculation.pricesIncludeTax,taxDisplayMode:"both"===this.config.taxCalculation.displayMode?"excl":this.config.taxCalculation.displayMode,crossSells:[],isEmpty:!0,createdAt:e,updatedAt:e,sessionId:t}}updateCartWithItems(e,t){const r=t.reduce((e,t)=>e+t.quantity,0),i=this.calculator.calculate(t,e.appliedCoupons);return{...e,items:t,itemCount:r,totals:i,isEmpty:0===t.length,needsShipping:t.some(e=>void 0!==e.weight||void 0!==e.dimensions),needsPayment:i.total>0,updatedAt:new Date}}setAuthContext(e){this.authContext=e,e?.isAuthenticated&&this.config.sync.enabled&&this.config.sync.syncOnAuth&&this.syncCartWithServer().catch(e=>{console.error("Failed to sync cart on authentication:",e)})}getAuthContext(){return this.authContext}getSyncStatus(){return this.syncManager.getStatus()}getLastSyncAt(){return this.syncManager.getLastSyncAt()}addSyncEventHandler(e){this.syncManager.addEventHandler(e)}removeSyncEventHandler(e){this.syncManager.removeEventHandler(e)}async syncCartWithServer(){if(!this.config.sync.enabled)return r({success:!0,status:"idle",conflicts:[],syncedAt:new Date,changes:{itemsAdded:0,itemsUpdated:0,itemsRemoved:0,couponsAdded:0,couponsRemoved:0}});if(!this.authContext?.isAuthenticated)return i(w.cartError("User must be authenticated for cart synchronization",{context:"manual_sync"}));const e=await this.getCart();if(!e.success)return e;const t=await this.syncManager.syncCart(e.data,this.authContext);return t.success&&t.data.mergedCart&&(this.currentCart=t.data.mergedCart,await this.persistence.save(t.data.mergedCart)),t}enableSync(){this.syncManager.enable()}disableSync(){this.syncManager.disable()}async processOfflineQueue(){if(!this.authContext?.isAuthenticated)return r(void 0);const e=await this.getCart();return e.success?this.syncManager.processQueue(e.data,this.authContext):e}destroy(){this.syncManager.destroy(),this.currentCart=null,this.authContext=null}}const Y=e.z.object({field:e.z.string(),operator:e.z.enum(["eq","ne","gt","gte","lt","lte","in","nin","contains","startswith","endswith","between","exists","empty"]),value:e.z.unknown(),label:e.z.string().optional()}),Z=e.z.object({field:e.z.string(),min:e.z.union([e.z.number(),e.z.string()]).optional(),max:e.z.union([e.z.number(),e.z.string()]).optional(),label:e.z.string().optional()}),X=e.z.object({field:e.z.string(),direction:e.z.enum(["asc","desc"]),label:e.z.string().optional()}),ee=e.z.object({page:e.z.number().min(1),limit:e.z.number().min(1).max(100),offset:e.z.number().min(0),total:e.z.number().min(0),totalPages:e.z.number().min(0)}),te=e.z.object({text:e.z.string().optional(),filters:e.z.array(Y),rangeFilters:e.z.array(Z),categoryIds:e.z.array(e.z.number().positive()).optional(),tagIds:e.z.array(e.z.number().positive()).optional(),productIds:e.z.array(e.z.number().positive()).optional(),excludeProductIds:e.z.array(e.z.number().positive()).optional(),inStock:e.z.boolean().optional(),onSale:e.z.boolean().optional(),featured:e.z.boolean().optional(),minPrice:e.z.number().min(0).optional(),maxPrice:e.z.number().min(0).optional(),minRating:e.z.number().min(0).max(5).optional(),attributes:e.z.record(e.z.union([e.z.string(),e.z.array(e.z.string())])).optional(),sort:e.z.array(X),pagination:ee,operator:e.z.enum(["AND","OR","NOT"]),fuzzy:e.z.boolean(),highlight:e.z.boolean(),facets:e.z.boolean(),suggestions:e.z.boolean()});e.z.object({type:e.z.enum(["search","filter","sort","paginate","suggestion_click","result_click"]),query:e.z.string().optional(),filters:e.z.array(Y).optional(),resultPosition:e.z.number().positive().optional(),productId:e.z.number().positive().optional(),timestamp:e.z.date(),sessionId:e.z.string(),userId:e.z.string().optional(),metadata:e.z.record(e.z.unknown()).optional()});class re{constructor(e,t){this.searchHistory=[],this.config=e,this.cache=t,this.sessionId=K()}async trackEvent(e){try{if(!this.config.analytics.enabled)return r(void 0);const t=`search-analytics:${e.type}:${Date.now()}`;return await this.cache.set(t,e),"search"===e.type&&e.query&&await this.updateSearchHistory(e.query,0),r(void 0)}catch(t){return i(w.cacheError("Failed to track search event",t))}}async getSearchHistory(e=10){try{const t="search-history",i=await this.cache.get(t);return i.success&&i.data?r(i.data.slice(0,e)):r([])}catch(t){return i(w.cacheError("Failed to get search history",t))}}async updateSearchHistory(e,t){const r={query:e,timestamp:new Date,resultCount:t,clickedResults:[],conversions:[]};this.searchHistory.unshift(r),this.searchHistory=this.searchHistory.slice(0,50),await this.cache.set("search-history",this.searchHistory)}getSessionId(){return this.sessionId}}class ie{constructor(){this.query={filters:[],rangeFilters:[],sort:[],operator:"AND",fuzzy:!0,highlight:!0,facets:!0,suggestions:!0,pagination:{page:1,limit:20,offset:0,total:0,totalPages:0}}}text(e){return this.query.text=e,this}filter(e,t,r){return this.query.filters.push({field:e,operator:t,value:r}),this}range(e,t,r){if(void 0!==t||void 0!==r){const i={field:e,...void 0!==t&&{min:t},...void 0!==r&&{max:r}};this.query.rangeFilters.push(i)}return this}category(e){return this.query.categoryIds=Array.isArray(e)?e:[e],this}tag(e){return this.query.tagIds=Array.isArray(e)?e:[e],this}price(e,t){return void 0!==e&&(this.query.minPrice=e),void 0!==t&&(this.query.maxPrice=t),this}rating(e){return this.query.minRating=e,this}inStock(e=!0){return this.query.inStock=e,this}onSale(e=!0){return this.query.onSale=e,this}featured(e=!0){return this.query.featured=e,this}attribute(e,t){return this.query.attributes||(this.query.attributes={}),this.query.attributes[e]=t,this}sort(e,t="asc"){return this.query.sort.push({field:e,direction:t}),this}page(e){return this.query.pagination={...this.query.pagination,page:e,offset:(e-1)*this.query.pagination.limit},this}limit(e){return this.query.pagination={...this.query.pagination,limit:e,offset:(this.query.pagination.page-1)*e},this}fuzzy(e=!0){return this.query.fuzzy=e,this}highlight(e=!0){return this.query.highlight=e,this}facets(e=!0){return this.query.facets=e,this}suggestions(e=!0){return this.query.suggestions=e,this}build(){return{text:this.query.text||"",filters:[...this.query.filters],rangeFilters:[...this.query.rangeFilters],...this.query.categoryIds&&{categoryIds:[...this.query.categoryIds]},...this.query.tagIds&&{tagIds:[...this.query.tagIds]},...this.query.productIds&&{productIds:[...this.query.productIds]},...this.query.excludeProductIds&&{excludeProductIds:[...this.query.excludeProductIds]},inStock:this.query.inStock,onSale:this.query.onSale,featured:this.query.featured,minPrice:this.query.minPrice,maxPrice:this.query.maxPrice,minRating:this.query.minRating,attributes:this.query.attributes?{...this.query.attributes}:void 0,sort:[...this.query.sort],pagination:{...this.query.pagination},operator:this.query.operator,fuzzy:this.query.fuzzy,highlight:this.query.highlight,facets:this.query.facets,suggestions:this.query.suggestions}}reset(){return this.query={filters:[],rangeFilters:[],sort:[],operator:"AND",fuzzy:!0,highlight:!0,facets:!0,suggestions:!0,pagination:{page:1,limit:20,offset:0,total:0,totalPages:0}},this}}class ae{constructor(e,t,r){this.fuseInstance=null,this.productsIndex=[],this.client=e,this.cache=t,this.config=r,this.analytics=new re(r,t),this.initializeFuseInstance()}async initializeFuseInstance(){try{const e=await this.cache.get("search-index");e.success&&e.data?(this.productsIndex=e.data,this.createFuseInstance()):await this.refreshSearchIndex()}catch(e){console.warn("Failed to initialize search index:",e)}}createFuseInstance(){const e={includeScore:this.config.fuzzy.includeScore,includeMatches:this.config.highlighting.enabled,threshold:this.config.fuzzy.threshold,distance:this.config.fuzzy.distance,minMatchCharLength:this.config.fuzzy.minMatchCharLength,keys:[{name:"name",weight:.4},{name:"description",weight:.2},{name:"short_description",weight:.2},{name:"sku",weight:.3},{name:"categories.name",weight:.1},{name:"tags.name",weight:.1}]};this.fuseInstance=new t(this.productsIndex,e)}async refreshSearchIndex(){try{const e=[];let t=1;const i=100;let a=!0;for(;a;){const r=await this.client.get(`/products?page=${t}&per_page=${i}&status=publish`);if(!r.success)return r;const s=r.data.data;if(0===s.length?a=!1:(e.push(...s),t++),t>50)break}return this.productsIndex=e,this.createFuseInstance(),await this.cache.set("search-index",e),r(void 0)}catch(e){return i(w.apiError("Failed to refresh search index",500,e))}}async quickSearch(e){try{const t=this.createQueryBuilder();if(e.query&&t.text(e.query),e.category&&t.category(e.category),void 0===e.minPrice&&void 0===e.maxPrice||t.price(e.minPrice,e.maxPrice),void 0!==e.inStock&&t.inStock(e.inStock),void 0!==e.onSale&&t.onSale(e.onSale),void 0!==e.featured&&t.featured(e.featured),void 0!==e.page&&t.page(e.page),void 0!==e.limit&&t.limit(e.limit),e.sort){const[r,i]=e.sort.split(":");t.sort(r,i||"asc")}return this.search(t.build())}catch(t){return i(w.apiError("Failed to perform quick search",500,t))}}async search(e){const t=performance.now();try{const i=this.validateSearchQuery(e);if(!i.success)return i;const a=this.generateCacheKey(e);if(this.config.caching.enabled){const e=await this.cache.get(a);if(e.success&&e.data)return r(e.data)}await this.analytics.trackEvent({type:"search",query:e.text,filters:e.filters,timestamp:new Date,sessionId:this.analytics.getSessionId()});let s=[];if(e.text&&this.fuseInstance){s=this.fuseInstance.search(e.text).map(e=>({item:e.item,score:e.score||0,highlights:this.extractHighlights(e),matchedFields:this.extractMatchedFields(e)}))}else s=this.productsIndex.map(e=>({item:e,score:1,highlights:[],matchedFields:[]}));s=this.applyFilters(s,e),s=this.applySorting(s,e.sort);const n=s.length,o=s.length>0?Math.max(...s.map(e=>e.score)):0,{paginatedResults:c,pagination:d}=this.applyPagination(s,e.pagination),u=e.facets?this.generateFacets(s,e):[],l=this.generateAggregations(s,e),h=e.suggestions?await this.generateSuggestions(e.text||""):[],p=performance.now()-t,m={query:e,items:c,aggregations:l,facets:u,suggestions:h,pagination:d,processingTime:p,totalHits:n,maxScore:o,debug:this.config.analytics.enabled?{parsedQuery:e,executionStats:{indexSize:this.productsIndex.length,processingTime:p,cacheHit:!1}}:void 0};return this.config.caching.enabled&&await this.cache.set(a,m),r(m)}catch(a){return i(w.apiError("Search failed",500,a))}}async autoComplete(e){const t=performance.now();try{if(e.query.length<this.config.suggestions.minQueryLength)return r({query:e.query,suggestions:[],products:[],categories:[],processingTime:performance.now()-t});const i=[],a=[];if(this.fuseInstance&&e.includeProducts){const t=this.fuseInstance.search(e.query,{limit:e.limit||5});a.push(...t.map(e=>e.item)),t.forEach(e=>{i.push({text:e.item.name,type:"product",score:e.score||0,metadata:{productId:e.item.id}})})}const s=[];return r({query:e.query,suggestions:i.slice(0,e.limit||10),products:a,categories:s,processingTime:performance.now()-t})}catch(a){return i(w.apiError("Auto-complete failed",500,a))}}createQueryBuilder(){return new ie}async getSearchHistory(e){return this.analytics.getSearchHistory(e)}async trackResultClick(e,t,r){return this.analytics.trackEvent({type:"result_click",query:r,productId:e,resultPosition:t,timestamp:new Date,sessionId:this.analytics.getSessionId()})}validateSearchQuery(e){try{return te.parse(e),r(void 0)}catch(t){return i(w.validationError("Invalid search query",t))}}generateCacheKey(e){const t={text:e.text,filters:e.filters,rangeFilters:e.rangeFilters,sort:e.sort,pagination:{page:e.pagination.page,limit:e.pagination.limit}};return`search:${btoa(JSON.stringify(t))}`}extractHighlights(e){return this.config.highlighting.enabled&&e.matches?e.matches.map(e=>({field:e.key||"",matches:[{text:e.value||"",indices:e.indices||[]}]})):[]}extractMatchedFields(e){return e.matches?e.matches.map(e=>e.key||"").filter(Boolean):[]}applyFilters(e,t){let r=[...e];return t.categoryIds&&t.categoryIds.length>0&&(r=r.filter(e=>e.item.categories.some(e=>t.categoryIds.includes(e.id)))),void 0!==t.inStock&&(r=r.filter(e=>t.inStock?"instock"===e.item.stock_status:"instock"!==e.item.stock_status)),void 0!==t.onSale&&(r=r.filter(e=>t.onSale?e.item.on_sale:!e.item.on_sale)),void 0!==t.featured&&(r=r.filter(e=>t.featured?e.item.featured:!e.item.featured)),void 0===t.minPrice&&void 0===t.maxPrice||(r=r.filter(e=>{const r=parseFloat(e.item.price)||0,i=void 0===t.minPrice||r>=t.minPrice,a=void 0===t.maxPrice||r<=t.maxPrice;return i&&a})),t.filters.forEach(e=>{r=this.applyCustomFilter(r,e)}),t.rangeFilters.forEach(e=>{r=this.applyRangeFilter(r,e)}),r}applyCustomFilter(e,t){return e}applyRangeFilter(e,t){return e}applySorting(e,t){return 0===t.length?e.sort((e,t)=>t.score-e.score):e.sort((e,r)=>{for(const i of t){let t,a;switch(i.field){case"price":t=parseFloat(e.item.price)||0,a=parseFloat(r.item.price)||0;break;case"name":t=e.item.name,a=r.item.name;break;case"date":t=new Date(e.item.date_created),a=new Date(r.item.date_created);break;case"rating":t=parseFloat(e.item.average_rating)||0,a=parseFloat(r.item.average_rating)||0;break;case"popularity":t=e.item.total_sales||0,a=r.item.total_sales||0;break;default:t=e.score,a=r.score}if(t<a)return"asc"===i.direction?-1:1;if(t>a)return"asc"===i.direction?1:-1}return 0})}applyPagination(e,t){const r=e.length,i=Math.ceil(r/t.limit),a=(t.page-1)*t.limit;return{paginatedResults:e.slice(a,a+t.limit),pagination:{...t,total:r,totalPages:i,offset:a}}}generateFacets(e,t){return[]}generateAggregations(e,t){const r=[];if(e.length>0){const t=e.map(e=>parseFloat(e.item.price)||0).filter(e=>e>0);t.length>0&&r.push({field:"price",type:"stats",stats:{min:Math.min(...t),max:Math.max(...t),avg:t.reduce((e,t)=>e+t,0)/t.length,count:t.length}})}return r}async generateSuggestions(e){const t=[];if(!e||e.length<this.config.suggestions.minQueryLength)return t;const r=await this.analytics.getSearchHistory(5);return r.success&&r.data.forEach(r=>{r.query.toLowerCase().includes(e.toLowerCase())&&t.push({text:r.query,type:"query",score:r.resultCount/100,metadata:{timestamp:r.timestamp}})}),t.slice(0,this.config.suggestions.maxSuggestions)}}e.z.object({type:e.z.enum(["billing","shipping"]),firstName:e.z.string().min(1),lastName:e.z.string().min(1),company:e.z.string().optional(),address1:e.z.string().min(1),address2:e.z.string().optional(),city:e.z.string().min(1),state:e.z.string().min(1),postcode:e.z.string().min(1),country:e.z.string().length(2),phone:e.z.string().optional(),email:e.z.string().email().optional(),isDefault:e.z.boolean()}),e.z.object({language:e.z.string().length(2),currency:e.z.string().length(3),timezone:e.z.string(),dateFormat:e.z.string(),timeFormat:e.z.enum(["12h","24h"]),emailNotifications:e.z.object({orderUpdates:e.z.boolean(),promotions:e.z.boolean(),newsletter:e.z.boolean(),wishlistReminders:e.z.boolean(),backInStock:e.z.boolean(),priceDrops:e.z.boolean()}),privacy:e.z.object({profileVisibility:e.z.enum(["public","private","friends"]),showPurchaseHistory:e.z.boolean(),allowRecommendations:e.z.boolean(),dataSharing:e.z.boolean()})}),e.z.object({id:e.z.number().positive(),wordpressUserId:e.z.number().positive(),username:e.z.string().min(1),email:e.z.string().email(),firstName:e.z.string().min(1),lastName:e.z.string().min(1),displayName:e.z.string().min(1),avatar:e.z.string().url().optional(),bio:e.z.string().optional(),website:e.z.string().url().optional(),phone:e.z.string().optional(),dateOfBirth:e.z.string().optional(),gender:e.z.enum(["male","female","other","prefer_not_to_say"]).optional(),roles:e.z.array(e.z.enum(["customer","shop_manager","administrator","editor","author","contributor","subscriber"])),status:e.z.enum(["active","inactive","pending","suspended"]),dateRegistered:e.z.string(),lastLogin:e.z.string().optional(),isEmailVerified:e.z.boolean(),isPhoneVerified:e.z.boolean()});const se=e.z.object({userId:e.z.number().positive(),externalUserId:e.z.string().optional(),syncProfile:e.z.boolean().optional(),syncAddresses:e.z.boolean().optional(),syncPreferences:e.z.boolean().optional(),syncOrderHistory:e.z.boolean().optional(),syncWishlist:e.z.boolean().optional(),forceRefresh:e.z.boolean().optional()}),ne=e.z.object({userId:e.z.number().positive(),externalUserId:e.z.string().optional(),email:e.z.string().email(),isAuthenticated:e.z.boolean(),accessToken:e.z.string().optional(),refreshToken:e.z.string().optional(),tokenExpiry:e.z.string().optional(),permissions:e.z.array(e.z.string()).optional(),sessionId:e.z.string().optional()});class oe{constructor(e,t,r){this.client=e,this.cache=t,this.config=r}async sendVerification(e){try{if(!this.config.enabled)return i(w.configurationError("Email verification is disabled","Enable email verification in configuration to use this feature"));const t=await this.checkRateLimit(e.userId,e.email);if(!t.success)return t;const a=this.generateVerificationToken(),s=new Date(Date.now()+60*this.config.tokenExpiryMinutes*1e3),n={token:a,userId:e.userId,email:e.email,createdAt:new Date,expiresAt:s,isUsed:!1,attempts:0};await this.storeVerificationToken(n);const o=await this.sendVerificationEmail(e,a);return o.success?(await this.updateRateLimit(e.userId,e.email),r({success:!0,tokenId:a,expiresAt:s,message:"Verification email sent successfully"})):(await this.removeVerificationToken(a),o)}catch(t){return i(w.apiError("Failed to send verification email",500,t))}}async confirmVerification(e){try{if(!this.config.enabled)return i(w.configurationError("Email verification is disabled"));const t=await this.getVerificationToken(e.token);if(!t.success)return i(w.validationError("Invalid or expired verification token"));const a=t.data;if(a.isUsed)return i(w.validationError("Verification token has already been used"));if(new Date>a.expiresAt)return await this.removeVerificationToken(e.token),i(w.validationError("Verification token has expired"));if(e.userId&&e.userId!==a.userId)return i(w.validationError("Token does not match user"));const s=await this.markEmailAsVerified(a.userId,a.email);if(!s.success)return s;await this.markTokenAsUsed(e.token),await this.clearRateLimit(a.userId,a.email);const n=new Date;return r({success:!0,userId:a.userId,email:a.email,verifiedAt:n,message:"Email verified successfully"})}catch(t){return i(w.apiError("Failed to confirm email verification",500,t))}}async getVerificationStatus(e){try{const t=await this.client.get(`/wp/v2/users/${e}`);if(!t.success)return i(w.apiError("Failed to get user data",404,"User not found"));const a=t.data.data.email,s=await this.isEmailVerified(e),n=await this.getVerificationDate(e),o=await this.getPendingTokens(e,a),c=o.length>0,d=o.length>0?o[0].createdAt:void 0,u=await this.getRateLimitInfo(e,a),l=Math.max(0,this.config.maxResendAttempts-u.attempts);return r({userId:e,email:a,isVerified:s,...n&&{verificationDate:n},pendingVerification:c,...d&&{lastTokenSent:d},attemptsRemaining:l})}catch(t){return i(w.apiError("Failed to get verification status",500,t))}}async resendVerification(e){try{const t=await this.client.get(`/wp/v2/users/${e}`);if(!t.success)return i(w.apiError("User not found",404));const r=t.data.data.email;return await this.isEmailVerified(e)?i(w.validationError("Email is already verified")):(await this.invalidateUserTokens(e,r),this.sendVerification({userId:e,email:r,templateType:"resend"}))}catch(t){return i(w.apiError("Failed to resend verification email",500,t))}}isVerificationRequired(e){switch(e){case"purchase":return this.config.requireVerificationForPurchase;case"profile_update":case"password_change":return this.config.enabled;default:return!1}}generateVerificationToken(){const e=Date.now().toString(36),t=Math.random().toString(36).substr(2,16);return`${e}${t}${this.simpleHash(`${e}-${t}`)}`.substr(0,64)}simpleHash(e){let t=0;for(let r=0;r<e.length;r++){t=(t<<5)-t+e.charCodeAt(r),t&=t}return Math.abs(t).toString(36)}async storeVerificationToken(e){try{const t=`email_verification:${e.token}`;await this.cache.set(t,e,60*this.config.tokenExpiryMinutes);const i="_email_verification_tokens",a=[...await this.getUserTokens(e.userId),e];return await this.client.post(`/wp/v2/users/${e.userId}`,{meta:{[i]:JSON.stringify(a)}}),r(void 0)}catch(t){return i(w.cacheError("Failed to store verification token",t))}}async getVerificationToken(e){try{const t=`email_verification:${e}`,a=await this.cache.get(t);return a.success&&a.data?r(a.data):i(w.validationError("Verification token not found"))}catch(t){return i(w.cacheError("Failed to retrieve verification token",t))}}async markEmailAsVerified(e,t){try{const i={isEmailVerified:!0,emailVerifiedAt:(new Date).toISOString(),verifiedEmail:t};return await this.client.post(`/wp/v2/users/${e}`,{meta:{_email_verified:"true",_email_verified_at:i.emailVerifiedAt,_verified_email:t}}),r(void 0)}catch(a){return i(w.apiError("Failed to mark email as verified",500,a))}}async isEmailVerified(e){try{const t=await this.client.get(`/wp/v2/users/${e}`);if(t.success){return"true"===(t.data.data.meta||{})._email_verified}return!1}catch{return!1}}async getVerificationDate(e){try{const t=await this.client.get(`/wp/v2/users/${e}`);if(t.success){const e=(t.data.data.meta||{})._email_verified_at;return e?new Date(e):void 0}return}catch{return}}async sendVerificationEmail(e,t){try{const i=this.getEmailTemplate(e.templateType||"welcome"),a=this.buildVerificationUrl(t,e.returnUrl),s={to:e.email,subject:i.subject,html:this.processTemplate(i.htmlBody,{verificationUrl:a,userId:e.userId,email:e.email,expiryMinutes:this.config.tokenExpiryMinutes}),text:this.processTemplate(i.textBody,{verificationUrl:a,userId:e.userId,email:e.email,expiryMinutes:this.config.tokenExpiryMinutes}),from:{email:i.fromEmail,name:i.fromName}},n=await this.sendEmail(s);return n.success?r({success:!0,tokenId:t,expiresAt:new Date(Date.now()+60*this.config.tokenExpiryMinutes*1e3),message:"Verification email sent successfully"}):n}catch(a){return i(w.apiError("Failed to send verification email",500,a))}}buildVerificationUrl(e,t){let r=`${this.config.baseUrl.replace(/\/$/,"")}/${this.config.verificationPath.replace(/^\//,"")}?token=${encodeURIComponent(e)}`;return t&&(r+=`&return_url=${encodeURIComponent(t)}`),r}getEmailTemplate(e){return this.config.templates[e]}processTemplate(e,t){let r=e;for(const[i,a]of Object.entries(t)){const e=`{{${i}}}`;r=r.replace(new RegExp(e,"g"),String(a))}return r}async sendEmail(e){try{return console.log("📧 Email would be sent:",e.subject,"to",e.to),r({success:!0,tokenId:"sent",expiresAt:new Date,message:"Email sent successfully"})}catch(t){return i(w.apiError("Email delivery failed",500,t))}}async checkRateLimit(e,t){const a=await this.getRateLimitInfo(e,t);if(a.attempts>=this.config.maxResendAttempts){const e=new Date(a.lastAttempt.getTime()+60*this.config.resendCooldownMinutes*1e3);if(new Date<e)return i(w.validationError(`Too many verification attempts. Please wait ${this.config.resendCooldownMinutes} minutes before trying again.`))}return r(void 0)}async getRateLimitInfo(e,t){try{const r=`email_verification_rate_limit:${e}:${t}`,i=await this.cache.get(r);return i.success&&i.data?{attempts:i.data.attempts,lastAttempt:new Date(i.data.lastAttempt)}:{attempts:0,lastAttempt:new Date(0)}}catch{return{attempts:0,lastAttempt:new Date(0)}}}async updateRateLimit(e,t){try{const r=`email_verification_rate_limit:${e}:${t}`,i={attempts:(await this.getRateLimitInfo(e,t)).attempts+1,lastAttempt:(new Date).toISOString()};await this.cache.set(r,i,86400)}catch(r){console.warn("Failed to update rate limit:",r)}}async clearRateLimit(e,t){try{const r=`email_verification_rate_limit:${e}:${t}`;await this.cache.delete(r)}catch(r){console.warn("Failed to clear rate limit:",r)}}async getUserTokens(e){try{const t=await this.client.get(`/wp/v2/users/${e}`);if(t.success){const e=(t.data.data.meta||{})._email_verification_tokens;return e?JSON.parse(e):[]}return[]}catch{return[]}}async getPendingTokens(e,t){const r=await this.getUserTokens(e),i=new Date;return r.filter(e=>e.email===t&&!e.isUsed&&new Date(e.expiresAt)>i)}async markTokenAsUsed(e){try{const t=`email_verification:${e}`,r=await this.cache.get(t);if(r.success&&r.data){const e={...r.data,isUsed:!0};await this.cache.set(t,e,60*this.config.tokenExpiryMinutes)}}catch(t){console.warn("Failed to mark token as used:",t)}}async removeVerificationToken(e){try{const t=`email_verification:${e}`;await this.cache.delete(t)}catch(t){console.warn("Failed to remove verification token:",t)}}async invalidateUserTokens(e,t){try{const r=await this.getPendingTokens(e,t);for(const e of r)await this.removeVerificationToken(e.token)}catch(r){console.warn("Failed to invalidate user tokens:",r)}}}const ce={enabled:!0,tokenExpiryMinutes:60,maxAttemptsPerDay:5,maxResendAttempts:3,resendCooldownMinutes:15,baseUrl:"",verificationPath:"/verify-email",autoVerifyOnRegistration:!1,requireVerificationForPurchase:!1,emailService:{provider:"smtp",fromEmail:"noreply@example.com",fromName:"WooCommerce Store"},templates:{welcome:{type:"welcome",subject:"Welcome! Please verify your email address",htmlBody:'\n        <h2>Welcome to our store!</h2>\n        <p>Please click the link below to verify your email address:</p>\n        <a href="{{verificationUrl}}" style="background: #0073aa; color: white; padding: 12px 24px; text-decoration: none; border-radius: 4px;">Verify Email</a>\n        <p>This link will expire in {{expiryMinutes}} minutes.</p>\n        <p>If you didn\'t create this account, please ignore this email.</p>\n      ',textBody:"\n        Welcome to our store!\n        \n        Please verify your email address by clicking this link:\n        {{verificationUrl}}\n        \n        This link will expire in {{expiryMinutes}} minutes.\n        \n        If you didn't create this account, please ignore this email.\n      ",fromEmail:"noreply@example.com",fromName:"WooCommerce Store"},changeEmail:{type:"change_email",subject:"Verify your new email address",htmlBody:'\n        <h2>Email Address Change</h2>\n        <p>You requested to change your email address. Please click the link below to verify your new email:</p>\n        <a href="{{verificationUrl}}" style="background: #0073aa; color: white; padding: 12px 24px; text-decoration: none; border-radius: 4px;">Verify New Email</a>\n        <p>This link will expire in {{expiryMinutes}} minutes.</p>\n        <p>If you didn\'t request this change, please contact support immediately.</p>\n      ',textBody:"\n        Email Address Change\n        \n        You requested to change your email address. Please verify your new email by clicking this link:\n        {{verificationUrl}}\n        \n        This link will expire in {{expiryMinutes}} minutes.\n        \n        If you didn't request this change, please contact support immediately.\n      ",fromEmail:"noreply@example.com",fromName:"WooCommerce Store"},resend:{type:"resend",subject:"Email verification - Resent",htmlBody:'\n        <h2>Email Verification</h2>\n        <p>Here\'s your requested email verification link:</p>\n        <a href="{{verificationUrl}}" style="background: #0073aa; color: white; padding: 12px 24px; text-decoration: none; border-radius: 4px;">Verify Email</a>\n        <p>This link will expire in {{expiryMinutes}} minutes.</p>\n        <p>If you continue to have issues, please contact support.</p>\n      ',textBody:"\n        Email Verification\n        \n        Here's your requested email verification link:\n        {{verificationUrl}}\n        \n        This link will expire in {{expiryMinutes}} minutes.\n        \n        If you continue to have issues, please contact support.\n      ",fromEmail:"noreply@example.com",fromName:"WooCommerce Store"}}};class de{constructor(e,t,r){this.client=e,this.cache=t,this.config=r}async getCustomerDownloads(e){try{if(!this.config.enabled)return i(w.configurationError("Download management is disabled","Enable download management in configuration to use this feature"));const t=await this.client.get(`/customers/${e}/downloads`);if(!t.success)return i(w.apiError("Failed to fetch customer downloads",t.error?.statusCode||500,t.error));const a=t.data.data,s=[];for(const e of a){const t=await this.mapToCustomerDownload(e);t&&s.push(t)}return s.sort((e,t)=>t.orderDate.getTime()-e.orderDate.getTime()),r(s)}catch(t){return i(w.apiError("Failed to get customer downloads",500,t))}}async generateDownloadLink(e){try{const t=await this.validateDownloadPermission(e);if(!t.isValid||!t.permission)return i(w.validationError("Download permission validation failed",t.errors.join(", ")));const a=t.permission;if(this.config.rateLimiting.enabled){const t=await this.checkRateLimit(e.customerId,e.ipAddress);if(!t.success)return t}const s=this.generateSecureToken(a),n=new Date(Date.now()+60*this.config.security.tokenExpiryMinutes*1e3),o=await this.getFileInformation(a.downloadId);if(!o.success)return o;const c=o.data,d=this.generateSecureUrl(s,a.downloadId);await this.cacheDownloadToken(s,a,n);return r({downloadId:a.downloadId,customerId:a.customerId,orderId:a.orderId,productId:a.productId,downloadUrl:d,accessToken:s,expiresAt:n,downloadsRemaining:a.downloadsRemaining,fileSize:c.fileSize,fileName:c.fileName,secureUrl:d})}catch(t){return i(w.apiError("Failed to generate download link",500,t))}}async validateDownloadPermission(e){const t=[],r=[];try{const i=await this.client.get(`/customers/${e.customerId}/downloads/${e.permissionId}`);if(!i.success)return t.push("Download permission not found"),{isValid:!1,permission:void 0,errors:t,warnings:r};const a=i.data.data,s=this.mapToDownloadPermission(a);if(e.validateOwnership&&s.customerId!==e.customerId&&t.push("Customer does not own this download"),s.isActive||t.push("Download permission is not active"),s.downloadsRemaining<=0&&t.push("Download limit exceeded"),s.accessExpires&&new Date>s.accessExpires&&t.push("Download access has expired"),this.config.security.ipValidation){await this.validateCustomerIP(e.customerId,e.ipAddress)||r.push("Download from unusual IP address")}return{isValid:0===t.length,permission:0===t.length?s:void 0,errors:t,warnings:r}}catch(i){return t.push("Failed to validate download permission"),{isValid:!1,permission:void 0,errors:t,warnings:r}}}async trackDownload(e){try{if(!this.config.trackAnalytics)return r(void 0);const t=`download_analytics:${e.downloadId}:${Date.now()}`;await this.cache.set(t,e,86400);const i={download_id:e.downloadId,customer_id:e.customerId,product_id:e.productId,downloaded_at:e.downloadedAt.toISOString(),ip_address:e.ipAddress,user_agent:e.userAgent,file_size:e.fileSize,download_duration:e.downloadDuration,successful:e.successful,error_message:e.errorMessage,bandwidth:e.bandwidth};return await this.client.post("/download-analytics",i),r(void 0)}catch(t){return console.warn("Failed to track download analytics:",t),r(void 0)}}async serveFile(e){try{const t=await this.validateDownloadToken(e);if(!t.success)return t;const{permission:i,fileInfo:a}=t.data;await this.updateDownloadCount(i.permissionId);const s=await this.createFileStream(a.filePath,a.fileName,a.fileSize);if(!s.success)return s;Date.now();return await this.trackDownload({downloadId:i.downloadId,customerId:i.customerId,productId:i.productId,downloadedAt:new Date,ipAddress:"",userAgent:"",fileSize:a.fileSize,successful:!0,bandwidth:0}),r(s.data)}catch(t){return i(w.apiError("Failed to serve file download",500,t))}}async getDownloadStatistics(e,t,a){try{if(!this.config.trackAnalytics)return i(w.configurationError("Download analytics is disabled"));const s={};e&&(s.customer_id=e),t&&(s.start_date=t.toISOString().split("T")[0]),a&&(s.end_date=a.toISOString().split("T")[0]);const n=await this.client.get("/download-analytics/stats",s);if(!n.success)return i(w.apiError("Failed to fetch download statistics",n.error?.statusCode||500,n.error));const o=n.data.data;return r({totalDownloads:o.total_downloads||0,totalBandwidth:o.total_bandwidth||0,popularProducts:o.popular_products?.map(e=>({productId:e.product_id,productName:e.product_name,downloadCount:e.download_count}))||[],downloadsByDate:o.downloads_by_date?.map(e=>({date:e.date,count:e.count,bandwidth:e.bandwidth}))||[],averageFileSize:o.average_file_size||0,successRate:o.success_rate||100})}catch(s){return i(w.apiError("Failed to get download statistics",500,s))}}async cleanupExpiredDownloads(){try{return r(0)}catch(e){return i(w.apiError("Failed to cleanup expired downloads",500,e))}}async mapToCustomerDownload(e){try{const t=new Date,r=e.access_expires?new Date(e.access_expires):void 0,i=!!r&&t>r,a=e.downloads_remaining>0&&!i;return{permissionId:e.permission_id,orderId:e.order_id,orderDate:new Date(e.order_date),productId:e.product_id,productName:e.product_name,downloadId:e.download_id,fileName:e.file_name,fileSize:e.file_size||0,downloadsRemaining:e.downloads_remaining,accessExpires:r,downloadUrl:"",isExpired:i,canDownload:a}}catch(t){return console.warn("Failed to map download data:",t),null}}mapToDownloadPermission(e){return{permissionId:e.permission_id,customerId:e.customer_id,orderId:e.order_id,productId:e.product_id,downloadId:e.download_id,downloadsRemaining:e.downloads_remaining,accessGranted:new Date(e.access_granted),accessExpires:e.access_expires?new Date(e.access_expires):void 0,orderKey:e.order_key,isActive:e.is_active||!0}}generateSecureToken(e){const t=Date.now().toString(36);return`dl_${t}${Math.random().toString(36).substr(2,16)}${this.simpleHash(`${e.permissionId}-${e.customerId}-${t}`)}`.substr(0,64)}simpleHash(e){let t=0;for(let r=0;r<e.length;r++){t=(t<<5)-t+e.charCodeAt(r),t&=t}return Math.abs(t).toString(36)}generateSecureUrl(e,t){return`${this.config.storage.basePath}/download/${e}/${t}`}async cacheDownloadToken(e,t,r){const i=`download_token:${e}`,a={permission:t,expiresAt:r.toISOString(),createdAt:(new Date).toISOString()},s=Math.floor((r.getTime()-Date.now())/1e3);await this.cache.set(i,a,s)}async validateDownloadToken(e){try{const t=`download_token:${e}`,a=await this.cache.get(t);if(!a.success||!a.data)return i(w.validationError("Invalid or expired download token"));const s=a.data,n=new Date(s.expiresAt);if(new Date>n)return await this.cache.delete(t),i(w.validationError("Download token has expired"));const o=await this.getFileInformation(s.permission.downloadId);return o.success?r({permission:s.permission,fileInfo:o.data}):o}catch(t){return i(w.validationError("Failed to validate download token"))}}async getFileInformation(e){try{return r({downloadId:e,fileName:`file_${e}.zip`,fileSize:1048576,filePath:`/secure/downloads/${e}`,mimeType:"application/zip"})}catch(t){return i(w.apiError("Failed to get file information",500,t))}}async createFileStream(e,t,a){try{const e=new ReadableStream({start(e){e.enqueue(new Uint8Array([1,2,3,4,5])),e.close()}});return r({stream:e,fileName:t,fileSize:a,mimeType:this.getMimeType(t),headers:{"Content-Disposition":`attachment; filename="${t}"`,"Content-Length":a.toString(),"Content-Type":this.getMimeType(t),"Cache-Control":"no-cache, no-store, must-revalidate"}})}catch(s){return i(w.apiError("Failed to create file stream",500,s))}}getMimeType(e){const t=e.split(".").pop()?.toLowerCase();return{pdf:"application/pdf",zip:"application/zip",exe:"application/octet-stream",dmg:"application/octet-stream",mp4:"video/mp4",mp3:"audio/mpeg",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",txt:"text/plain"}[t||""]||"application/octet-stream"}async checkRateLimit(e,t){if(!this.config.rateLimiting.enabled)return r(void 0);try{const t=`rate_limit:downloads:${e}:${(new Date).getHours()}`,a=await this.cache.get(t),s=a.success&&a.data||0;return s>=this.config.rateLimiting.maxDownloadsPerHour?i(w.validationError(`Download rate limit exceeded. Maximum ${this.config.rateLimiting.maxDownloadsPerHour} downloads per hour.`)):(await this.cache.set(t,s+1,3600),r(void 0))}catch(a){return console.warn("Rate limiting check failed:",a),r(void 0)}}async validateCustomerIP(e,t){try{return!0}catch{return!1}}async updateDownloadCount(e){try{await this.client.post(`/download-permissions/${e}/increment`)}catch(t){console.warn("Failed to update download count:",t)}}}const ue={enabled:!0,maxDownloadsPerProduct:5,defaultExpiryDays:30,maxFileSize:524288e3,allowedFileTypes:["pdf","zip","exe","dmg","mp4","mp3","jpg","png"],secureDownloads:!0,trackAnalytics:!0,rateLimiting:{enabled:!0,maxDownloadsPerHour:10,maxBandwidthPerHour:1073741824},security:{tokenExpiryMinutes:60,ipValidation:!1,checksumValidation:!0,encryptFiles:!1},storage:{provider:"local",basePath:"/downloads",secureBasePath:"/secure/downloads"}};class le{constructor(e,t){this.cache=e,this.config=t}async getUserProfile(e){if(!this.config.cacheUserData)return r(null);try{const t=`user-profile:${e}`,i=await this.cache.get(t);return r(i.success?i.data:null)}catch(t){return i(w.cacheError("Failed to get cached user profile",t))}}async cacheUserProfile(e){if(!this.config.cacheUserData)return r(void 0);try{const t=`user-profile:${e.id}`;return await this.cache.set(t,e,this.config.cacheTtl),r(void 0)}catch(t){return i(w.cacheError("Failed to cache user profile",t))}}async clearUserCache(e){try{const t=[`user-profile:${e}`,`user-addresses:${e}`,`user-preferences:${e}`,`user-orders:${e}`,`user-wishlist:${e}`];for(const e of t)await this.cache.delete(e);return r(void 0)}catch(t){return i(w.cacheError("Failed to clear user cache",t))}}}class he{static validateAddress(e){const t=[],r=[];e.firstName.trim()||t.push("First name is required"),e.lastName.trim()||t.push("Last name is required"),e.address1.trim()||t.push("Address line 1 is required"),e.city.trim()||t.push("City is required"),e.state.trim()||t.push("State/Province is required"),e.postcode.trim()||t.push("Postal code is required"),e.country.trim()&&2===e.country.length||t.push("Valid country code is required"),e.email&&!this.isValidEmail(e.email)&&t.push("Invalid email format"),e.phone&&!this.isValidPhone(e.phone)&&r.push("Phone number format may be invalid"),this.isValidPostalCode(e.postcode,e.country)||r.push("Postal code format may be invalid for the selected country");return{isValid:0===t.length,errors:t,warnings:r}}static isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}static isValidPhone(e){return/^[\+]?[1-9][\d]{0,15}$/.test(e.replace(/[\s\-\(\)]/g,""))}static isValidPostalCode(e,t){const r={US:/^\d{5}(-\d{4})?$/,CA:/^[A-Za-z]\d[A-Za-z][ -]?\d[A-Za-z]\d$/,GB:/^[A-Z]{1,2}\d[A-Z\d]? ?\d[A-Z]{2}$/,DE:/^\d{5}$/,FR:/^\d{5}$/,AU:/^\d{4}$/}[t.toUpperCase()];return!r||r.test(e)}}class pe{constructor(e,t,r,i,a){this.currentAuthContext=null,this.client=e,this.cache=t,this.config=r,this.userCache=new le(t,r),this.emailVerification=new oe(e,t,i||ce),this.downloads=new de(e,t,a||ue)}setAuthContext(e){try{if(!function(e){try{return ne.parse(e),!0}catch{return!1}}(e))return i(w.validationError("Invalid authentication context","AuthContext must contain valid user information"));if(this.currentAuthContext=e,this.config.enabled&&this.config.syncOnLogin){const t={userId:e.userId};e.externalUserId&&(t.externalUserId=e.externalUserId),this.syncUserData(t).catch(e=>{console.warn("Background user sync failed:",e)})}return r(void 0)}catch(t){return i(w.apiError("Failed to set authentication context",500,t))}}getCurrentAuthContext(){return this.currentAuthContext}clearAuthContext(){try{return this.currentAuthContext&&this.userCache.clearUserCache(this.currentAuthContext.userId),this.currentAuthContext=null,r(void 0)}catch(e){return i(w.apiError("Failed to clear authentication context",500,e))}}async syncUserData(e){try{const t=this.validateSyncRequest(e);if(!t.success)return t;if(!this.config.enabled)return i(w.configurationError("User sync is disabled","Enable user sync in configuration to use this feature"));const a=[];let s,n,o,c,d,u;if(!1!==e.syncProfile&&this.config.syncProfile){const t=await this.syncUserProfile(e.userId);t.success?(s=t.data.profile,n=t.data.customerData):a.push(`Profile sync failed: ${t.error.message}`)}if(!1!==e.syncAddresses&&this.config.syncAddresses){const t=await this.syncUserAddresses(e.userId);t.success?o=t.data:a.push(`Address sync failed: ${t.error.message}`)}if(!1!==e.syncPreferences&&this.config.syncPreferences){const t=await this.syncUserPreferences(e.userId);t.success?c=t.data:a.push(`Preferences sync failed: ${t.error.message}`)}if(!1!==e.syncOrderHistory&&this.config.syncOrderHistory){const t=await this.syncUserOrderHistory(e.userId);t.success?d=t.data:a.push(`Order history sync failed: ${t.error.message}`)}if(!1!==e.syncWishlist&&this.config.syncWishlist){const t=await this.syncUserWishlist(e.userId);t.success?u=t.data:a.push(`Wishlist sync failed: ${t.error.message}`)}return r({userId:e.userId,syncedAt:(new Date).toISOString(),profile:s,customerData:n,addresses:o,preferences:c,orderHistory:d,wishlist:u,syncErrors:a.length>0?a:void 0})}catch(t){return i(w.apiError("User data sync failed",500,t))}}async getUserProfile(e,t=!0){try{if(t){const t=await this.userCache.getUserProfile(e);if(t.success&&t.data)return r(t.data)}const i=await this.client.get(`/wp/v2/users/${e}`);if(!i.success)return i;const a=i.data.data,s={id:a.id,wordpressUserId:a.id,username:a.username||a.slug,email:a.email,firstName:a.first_name||"",lastName:a.last_name||"",displayName:a.display_name||a.name,avatar:a.avatar_urls?.[96]||void 0,bio:a.description||void 0,website:a.url||void 0,roles:a.roles||["customer"],status:"active",dateRegistered:a.date||(new Date).toISOString(),lastLogin:void 0,isEmailVerified:!0,isPhoneVerified:!1};return await this.userCache.cacheUserProfile(s),r(s)}catch(a){return i(w.apiError("Failed to get user profile",500,a))}}async updateUserProfile(e,t){try{const r={};t.profile&&(t.profile.firstName&&(r.first_name=t.profile.firstName),t.profile.lastName&&(r.last_name=t.profile.lastName),t.profile.displayName&&(r.display_name=t.profile.displayName),t.profile.bio&&(r.description=t.profile.bio),t.profile.website&&(r.url=t.profile.website));const i=await this.client.post(`/wp/v2/users/${e}`,r);return i.success?(await this.userCache.clearUserCache(e),this.getUserProfile(e,!1)):i}catch(r){return i(w.apiError("Failed to update user profile",500,r))}}async getCustomerData(e){try{const t=await this.client.get(`/customers/${e}`);if(!t.success)return t;const i=t.data.data;return r({id:i.id,email:i.email,firstName:i.first_name,lastName:i.last_name,username:i.username,role:i.role||"customer",billing:this.transformWooAddressToUserAddress(i.billing,"billing"),shipping:this.transformWooAddressToUserAddress(i.shipping,"shipping"),isPayingCustomer:i.is_paying_customer||!1,ordersCount:i.orders_count||0,totalSpent:i.total_spent||"0",avatarUrl:i.avatar_url||"",dateCreated:i.date_created,dateModified:i.date_modified,metaData:i.meta_data||[]})}catch(t){return i(w.apiError("Failed to get customer data",500,t))}}validateAddress(e){return he.validateAddress(e)}async sendEmailVerification(e){return this.emailVerification.sendVerification(e)}async confirmEmailVerification(e){return this.emailVerification.confirmVerification(e)}async getEmailVerificationStatus(e){return this.emailVerification.getVerificationStatus(e)}async resendEmailVerification(e){return this.emailVerification.resendVerification(e)}isEmailVerificationRequired(e){return this.emailVerification.isVerificationRequired(e)}async getCustomerDownloads(e){return this.downloads.getCustomerDownloads(e)}async generateDownloadLink(e){return this.downloads.generateDownloadLink(e)}async getDownloadStatistics(e,t,r){return this.downloads.getDownloadStatistics(e,t,r)}async cleanupExpiredDownloads(){return this.downloads.cleanupExpiredDownloads()}async getUserOrderHistory(e,t=1,a=10){try{const i=await this.client.get(`/orders?customer=${e}&page=${t}&per_page=${Math.min(a,this.config.maxOrderHistory)}`);if(!i.success)return i;return r(i.data.data.map(e=>({id:e.id,orderNumber:e.number,status:e.status,currency:e.currency,total:e.total,totalTax:e.total_tax,subtotal:e.subtotal,shippingTotal:e.shipping_total,dateCreated:e.date_created,dateModified:e.date_modified,itemCount:e.line_items?.length||0,paymentMethod:e.payment_method,paymentMethodTitle:e.payment_method_title})))}catch(s){return i(w.apiError("Failed to get user order history",500,s))}}async logUserActivity(e){try{const t={...e,id:K(),timestamp:(new Date).toISOString()},i=`user-activity:${e.userId}:${t.id}`;return await this.cache.set(i,t,864e5),r(void 0)}catch(t){return i(w.cacheError("Failed to log user activity",t))}}validateSyncRequest(e){try{return se.parse(e),r(void 0)}catch(t){return i(w.validationError("Invalid sync request",t))}}async syncUserProfile(e){const t=await this.getUserProfile(e,!1);if(!t.success)return t;const i=t.data;let a;const s=await this.getCustomerData(e);return s.success&&(a=s.data),r({profile:i,customerData:a})}async syncUserAddresses(e){const t=await this.getCustomerData(e);if(!t.success)return t;const i=[],a=t.data;return a.billing&&i.push(a.billing),a.shipping&&i.push(a.shipping),r(i)}async syncUserPreferences(e){return r({language:"en",currency:"USD",timezone:"UTC",dateFormat:"YYYY-MM-DD",timeFormat:"24h",emailNotifications:{orderUpdates:!0,promotions:!1,newsletter:!1,wishlistReminders:!0,backInStock:!0,priceDrops:!1},privacy:{profileVisibility:"private",showPurchaseHistory:!1,allowRecommendations:!0,dataSharing:!1}})}async syncUserOrderHistory(e){return this.getUserOrderHistory(e,1,this.config.maxOrderHistory)}async syncUserWishlist(e){return r({id:`wishlist-${e}`,userId:e,name:"My Wishlist",items:[],isPublic:!1,dateCreated:(new Date).toISOString(),dateModified:(new Date).toISOString()})}transformWooAddressToUserAddress(e,t){return{type:t,firstName:e.first_name||"",lastName:e.last_name||"",company:e.company||void 0,address1:e.address_1||"",address2:e.address_2||void 0,city:e.city||"",state:e.state||"",postcode:e.postcode||"",country:e.country||"",phone:e.phone||void 0,email:e.email||void 0,isDefault:!0}}}const me={product_id:{min:1,type:"number"},review:{min:10,max:1e4,type:"string"},reviewer:{min:1,max:100,type:"string"},reviewer_email:{type:"email"},rating:{min:1,max:5,type:"number"},parent_id:{type:"number",optional:!0},images:{type:"array",optional:!0}};class ge{constructor(e,t){this.rateLimitStore=new Map,this.client=e,this.cache=t}async list(e={}){try{const t=this.validateListParams(e);if(!t.success)return t;const i=this.buildQueryParams(e),a=`reviews:list:${JSON.stringify(i)}`,s=await this.cache.get(a);if(s.success&&s.data)return r(s.data);const n=await this.client.get(`/products/reviews?${new URLSearchParams(i).toString()}`);if(!n.success)return n;const o=parseInt(n.data.headers["x-wp-total"]||"0"),c=parseInt(n.data.headers["x-wp-totalpages"]||"0"),d=n.data.data,u=this.calculateRatingDistribution(d),l=u.average,h={reviews:d,totalReviews:o,totalPages:c,currentPage:e.page||1,perPage:e.limit||10,averageRating:l,ratingDistribution:u};return await this.cache.set(a,h,300),r(h)}catch(t){return i(w.apiError("Failed to list reviews",500,t))}}async get(e){try{if(!e||e<=0)return i(w.validationError("Invalid review ID"));const t=`reviews:single:${e}`,a=await this.cache.get(t);if(a.success&&a.data)return r(a.data);const s=await this.client.get(`/products/reviews/${e}`);if(!s.success)return 404===s.error.statusCode?i(w.validationError("Review not found")):s;const n=s.data.data;return await this.cache.set(t,n,600),r(n)}catch(t){return i(w.apiError("Failed to get review",500,t))}}async create(e){try{const t=await this.validateReview(e);if(!t.isValid)return i(w.validationError("Review validation failed",t.errors));const a=await this.checkRateLimit(e.reviewer_email);if(!a.success)return a;let s=[];if(e.images&&e.images.length>0){const t=await this.processReviewImages(e.images);if(!t.success)return t;s=t.data}const n={product_id:e.product_id,review:this.sanitizeContent(e.review),reviewer:this.sanitizeContent(e.reviewer),reviewer_email:e.reviewer_email,rating:e.rating,parent:e.parent_id||0,status:t.requiresModeration?"hold":"approved"},o=await this.client.post("/products/reviews",n);if(!o.success)return o;const c=o.data.data;return s.length>0&&await this.attachImagesToReview(c.id,s),this.updateRateLimit(e.reviewer_email),await this.invalidateReviewCaches(e.product_id),await this.trackReviewEvent("review_created",{reviewId:c.id,productId:e.product_id,rating:e.rating,hasImages:s.length>0}),r(c)}catch(t){return i(w.apiError("Failed to create review",500,t))}}async update(e,t){try{if(!e||e<=0)return i(w.validationError("Invalid review ID"));const a=await this.get(e);if(!a.success)return a;const s={};if(void 0!==t.review&&(s.review=this.sanitizeContent(t.review)),void 0!==t.rating){if(t.rating<1||t.rating>5)return i(w.validationError("Rating must be between 1 and 5"));s.rating=t.rating}void 0!==t.status&&(s.status=t.status);const n=await this.client.put(`/products/reviews/${e}`,s);if(!n.success)return n;const o=n.data.data;return t.images&&await this.updateReviewImages(e,t.images),await this.cache.delete(`reviews:single:${e}`),await this.invalidateReviewCaches(a.data.product_id),r(o)}catch(a){return i(w.apiError("Failed to update review",500,a))}}async delete(e,t=!1){try{if(!e||e<=0)return i(w.validationError("Invalid review ID"));const a=await this.get(e);if(!a.success)return a;const s=await this.client.delete(`/products/reviews/${e}?force=${t}`);return s.success?(await this.cache.delete(`reviews:single:${e}`),await this.invalidateReviewCaches(a.data.product_id),r(!0)):s}catch(a){return i(w.apiError("Failed to delete review",500,a))}}async getProductReviews(e,t={}){return this.list({...t,product:e})}async getAnalytics(e,t="30d"){try{if(!e||e<=0)return i(w.validationError("Invalid product ID"));const a=`reviews:analytics:${e}:${t}`,s=await this.cache.get(a);if(s.success&&s.data)return r(s.data);const n=await this.getProductReviews(e,{limit:1e3});if(!n.success)return n;const o=n.data.reviews,c=this.calculateRatingDistribution(o),d=o.filter(e=>e.verified),u=o.filter(e=>e.replies&&e.replies.length>0),l=o.reduce((e,t)=>e+t.helpful_votes,0),h=await this.getPreviousPeriodData(e,t),p={productId:e,totalReviews:o.length,averageRating:c.average,ratingDistribution:c,verifiedPurchaseRatio:o.length>0?d.length/o.length*100:0,responseRate:o.length>0?u.length/o.length*100:0,helpfulnessRatio:o.length>0?l/o.length:0,recentTrend:{period:t,averageRating:c.average,reviewCount:o.length,ratingChange:h?c.average-h.averageRating:0},topKeywords:await this.extractTopKeywords(o)};return await this.cache.set(a,p,3600),r(p)}catch(a){return i(w.apiError("Failed to get review analytics",500,a))}}async voteHelpful(e,t,a){try{if(!e||e<=0)return i(w.validationError("Invalid review ID"));if(a){if(await this.getUserVote(e,a))return i(w.validationError("User has already voted on this review"))}const s={review_id:e,vote_type:t,user_email:a,voted_at:(new Date).toISOString()},n=await this.client.post(`/products/reviews/${e}/vote`,s);return n.success?(await this.cache.delete(`reviews:single:${e}`),r(n.data.data)):n}catch(s){return i(w.apiError("Failed to vote on review",500,s))}}async moderate(e,t,a){try{if(!e||e<=0)return i(w.validationError("Invalid review ID"));if(!["approved","hold","spam","trash"].includes(t))return i(w.validationError("Invalid moderation action"));const s=await this.update(e,{status:t});if(!s.success)return s;const n={review_id:e,action:t,reason:a,moderated_at:(new Date).toISOString(),automated:!1};return await this.trackReviewEvent("review_moderated",{reviewId:e,action:t,reason:a}),r(n)}catch(s){return i(w.apiError("Failed to moderate review",500,s))}}async search(e){try{const t={page:e.pagination.page,limit:e.pagination.limit,search:e.query};if(e.filters)for(const r of e.filters)this.applyFilterToParams(t,r);if(e.sort&&e.sort.length>0){const r=e.sort[0];t.orderby=r.field,t.order=r.direction}return this.list(t)}catch(t){return i(w.apiError("Failed to search reviews",500,t))}}validateListParams(e){if(e.page&&e.page<1)return i(w.validationError("Page must be >= 1"));if(e.limit&&(e.limit<1||e.limit>100))return i(w.validationError("Limit must be between 1 and 100"));if(e.rating){const t=Array.isArray(e.rating)?e.rating:[e.rating];for(const e of t)if(e<1||e>5)return i(w.validationError("Rating must be between 1 and 5"))}return r(void 0)}buildQueryParams(e){const t={};return e.page&&(t.page=e.page.toString()),e.limit&&(t.per_page=e.limit.toString()),e.product&&(t.product=Array.isArray(e.product)?e.product.join(","):e.product.toString()),e.status&&(t.status=Array.isArray(e.status)?e.status.join(","):e.status),e.reviewer&&(t.reviewer=e.reviewer),e.reviewer_email&&(t.reviewer_email=e.reviewer_email),e.rating&&(t.rating=Array.isArray(e.rating)?e.rating.join(","):e.rating.toString()),void 0!==e.verified&&(t.verified=e.verified.toString()),e.after&&(t.after=e.after),e.before&&(t.before=e.before),e.search&&(t.search=e.search),e.orderby&&(t.orderby=e.orderby),e.order&&(t.order=e.order),e.include&&(t.include=e.include.join(",")),e.exclude&&(t.exclude=e.exclude.join(",")),e.parent&&(t.parent=e.parent.toString()),e.offset&&(t.offset=e.offset.toString()),t}calculateRatingDistribution(e){const t={1:0,2:0,3:0,4:0,5:0};for(const s of e){const e=Math.floor(s.rating);e>=1&&e<=5&&t[e]++}const r=e.length,i=r>0?e.reduce((e,t)=>e+t.rating,0)/r:0,a={1:r>0?t[1]/r*100:0,2:r>0?t[2]/r*100:0,3:r>0?t[3]/r*100:0,4:r>0?t[4]/r*100:0,5:r>0?t[5]/r*100:0};return{...t,total:r,average:Math.round(100*i)/100,percentage:a}}async validateReview(e){const t=[],r=[];try{me.parse(e)}catch(s){s instanceof z.ZodError&&t.push(...s.errors.map(e=>e.message))}const i=await this.calculateSpamScore(e.review),a=i>70||this.containsProfanity(e.review);return i>90?t.push("Review appears to be spam"):i>70&&r.push("Review may require manual moderation"),{isValid:0===t.length,errors:t,warnings:r,canSubmit:0===t.length,requiresModeration:a,spamScore:i}}async checkRateLimit(e){const t=Date.now(),a=e.toLowerCase(),s=this.rateLimitStore.get(a),n=36e5;if(s)if(t<s.resetTime){if(s.count>=5)return i(w.rateLimitError("Too many reviews submitted. Please wait before submitting another review.",Math.ceil((s.resetTime-t)/1e3)))}else this.rateLimitStore.set(a,{count:0,resetTime:t+n});else this.rateLimitStore.set(a,{count:0,resetTime:t+n});return r(void 0)}updateRateLimit(e){const t=e.toLowerCase(),r=this.rateLimitStore.get(t);r&&(r.count++,this.rateLimitStore.set(t,r))}sanitizeContent(e){return e.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi,"").trim()}async calculateSpamScore(e){let t=0;(e.match(/[A-Z]/g)||[]).length/e.length>.5&&(t+=30);(e.match(/[!?]{2,}/g)||[]).length>2&&(t+=25);const r=[/click here/gi,/free offer/gi,/limited time/gi,/act now/gi];for(const i of r)i.test(e)&&(t+=20);return Math.min(t,100)}containsProfanity(e){const t=e.toLowerCase();return["spam","fake","scam"].some(e=>t.includes(e))}async processReviewImages(e){return r([])}async attachImagesToReview(e,t){}async updateReviewImages(e,t){}async invalidateReviewCaches(e){const t=[`reviews:list:*${e}*`,`reviews:analytics:${e}*`];for(const r of t)await this.cache.deletePattern(r)}async trackReviewEvent(e,t){console.log(`Review event: ${e}`,t)}async getUserVote(e,t){return null}async getPreviousPeriodData(e,t){return null}async extractTopKeywords(e){return[]}applyFilterToParams(e,t){switch(t.field){case"rating":"eq"===t.operator&&(e.rating=t.value);break;case"verified":"eq"===t.operator&&(e.verified=t.value)}}}const ye=e.z.object({firstName:e.z.string().min(1,"First name is required").max(100),lastName:e.z.string().min(1,"Last name is required").max(100),company:e.z.string().max(100).optional(),address1:e.z.string().min(1,"Address is required").max(200),address2:e.z.string().max(200).optional(),city:e.z.string().min(1,"City is required").max(100),state:e.z.string().min(1,"State is required").max(100),postcode:e.z.string().min(1,"Postcode is required").max(20),country:e.z.string().length(2,"Country must be 2-letter code"),email:e.z.string().email().optional(),phone:e.z.string().max(20).optional()}),fe=ye.extend({email:e.z.string().email("Valid email is required")}),ve=ye;e.z.object({number:e.z.string().regex(/^\d{13,19}$/,"Invalid card number"),expiryMonth:e.z.number().int().min(1).max(12),expiryYear:e.z.number().int().min((new Date).getFullYear()),cvv:e.z.string().regex(/^\d{3,4}$/,"Invalid CVV"),holderName:e.z.string().min(1,"Cardholder name is required").max(100)}),e.z.object({subtotal:e.z.number().min(0),tax:e.z.number().min(0),shipping:e.z.number().min(0),shippingTax:e.z.number().min(0),discount:e.z.number().min(0),fees:e.z.number().min(0),feesTax:e.z.number().min(0),total:e.z.number().min(0),currency:e.z.string().length(3)}),e.z.object({step:e.z.enum(["cart_review","shipping_address","billing_address","shipping_method","payment_method","order_review","payment_processing","order_confirmation"]),data:e.z.record(e.z.unknown()),validate:e.z.boolean().optional()});const we={US:{code:"US",name:"United States",postcodePattern:"^\\d{5}(-\\d{4})?$",stateRequired:!0,postcodeRequired:!0,phonePattern:"^\\+?1?[-.\\s]?\\(?\\d{3}\\)?[-.\\s]?\\d{3}[-.\\s]?\\d{4}$"},CA:{code:"CA",name:"Canada",postcodePattern:"^[A-Za-z]\\d[A-Za-z]\\s?\\d[A-Za-z]\\d$",stateRequired:!0,postcodeRequired:!0,phonePattern:"^\\+?1?[-.\\s]?\\(?\\d{3}\\)?[-.\\s]?\\d{3}[-.\\s]?\\d{4}$"},GB:{code:"GB",name:"United Kingdom",postcodePattern:"^[A-Za-z]{1,2}\\d[A-Za-z\\d]?\\s?\\d[A-Za-z]{2}$",stateRequired:!1,postcodeRequired:!0,phonePattern:"^\\+?44[-.\\s]?\\d{4}[-.\\s]?\\d{6}$"},DE:{code:"DE",name:"Germany",postcodePattern:"^\\d{5}$",stateRequired:!1,postcodeRequired:!0,phonePattern:"^\\+?49[-.\\s]?\\d{3,4}[-.\\s]?\\d{7,8}$"},FR:{code:"FR",name:"France",postcodePattern:"^\\d{5}$",stateRequired:!1,postcodeRequired:!0,phonePattern:"^\\+?33[-.\\s]?\\d{1}[-.\\s]?\\d{2}[-.\\s]?\\d{2}[-.\\s]?\\d{2}[-.\\s]?\\d{2}$"},AU:{code:"AU",name:"Australia",postcodePattern:"^\\d{4}$",stateRequired:!0,postcodeRequired:!0,phonePattern:"^\\+?61[-.\\s]?\\d{1}[-.\\s]?\\d{4}[-.\\s]?\\d{4}$"},JP:{code:"JP",name:"Japan",postcodePattern:"^\\d{3}-\\d{4}$",stateRequired:!0,postcodeRequired:!0,phonePattern:"^\\+?81[-.\\s]?\\d{1,4}[-.\\s]?\\d{1,4}[-.\\s]?\\d{4}$"},BR:{code:"BR",name:"Brazil",postcodePattern:"^\\d{5}-?\\d{3}$",stateRequired:!0,postcodeRequired:!0,phonePattern:"^\\+?55[-.\\s]?\\d{2}[-.\\s]?\\d{4,5}[-.\\s]?\\d{4}$"},IN:{code:"IN",name:"India",postcodePattern:"^\\d{6}$",stateRequired:!0,postcodeRequired:!0,phonePattern:"^\\+?91[-.\\s]?\\d{5}[-.\\s]?\\d{5}$"},NL:{code:"NL",name:"Netherlands",postcodePattern:"^\\d{4}\\s?[A-Za-z]{2}$",stateRequired:!1,postcodeRequired:!0,phonePattern:"^\\+?31[-.\\s]?\\d{1,3}[-.\\s]?\\d{7}$"}};class Se{constructor(e){this.countryConfigs={...we,...e}}async validateAddressWithContext(e,t){try{const i=[],a=[],s=this.countryConfigs[e.country.toUpperCase()];if(!s)return i.push(`Country "${e.country}" is not supported`),r({isValid:!1,errors:i,warnings:a});const n=this.buildFieldRequirements(t,s);return this.validateRequiredFields(e,n,i),this.validateFieldFormats(e,s,i,a),r({isValid:0===i.length,errors:i,warnings:a})}catch(a){return i(w.validationError("Address validation failed",a))}}getFieldRequirements(e){const t=e.checkoutRules?.requiredFields?.[0]||"US",r=this.countryConfigs[t]||this.countryConfigs.US||{code:"US",name:"United States",stateRequired:!0,postcodeRequired:!0};return this.buildFieldRequirements(e,r)}isFieldRequired(e,t){return this.getFieldRequirements(t)[e]}async validateAddress(e){return this.validateAddressWithContext(e,{addressType:"shipping",isGuestCheckout:!1})}async validateBillingAddress(e){return this.validateAddressWithContext(e,{addressType:"billing",isGuestCheckout:!1,fieldRequirements:{email:!0}})}async validateShippingAddress(e){return this.validateAddressWithContext(e,{addressType:"shipping",isGuestCheckout:!1})}addressesEqual(e,t){return e.firstName===t.firstName&&e.lastName===t.lastName&&e.company===t.company&&e.address1===t.address1&&e.address2===t.address2&&e.city===t.city&&e.state===t.state&&e.postcode===t.postcode&&e.country===t.country&&e.phone===t.phone}async suggestAddressCorrection(e){try{const t=this.countryConfigs[e.country.toUpperCase()];if(!t)return r(null);const i={...e,firstName:this.capitalizeWords(e.firstName),lastName:this.capitalizeWords(e.lastName),city:this.capitalizeWords(e.city),country:e.country.toUpperCase(),postcode:this.formatPostcode(e.postcode,t)};return JSON.stringify(e)!==JSON.stringify(i)?r(i):r(null)}catch(t){return i(w.validationError("Address suggestion failed",t))}}getCountryConfig(e){return this.countryConfigs[e.toUpperCase()]||null}getSupportedCountries(){return Object.values(this.countryConfigs)}setCountryConfig(e,t){this.countryConfigs[e.toUpperCase()]=t}async parseAddress(e,t="base"){try{switch(t){case"billing":const t=function(e){const t=fe.parse(e);return{firstName:t.firstName,lastName:t.lastName,address1:t.address1,city:t.city,state:t.state,postcode:t.postcode,country:t.country,email:t.email,...void 0!==t.company&&{company:t.company},...void 0!==t.address2&&{address2:t.address2},...void 0!==t.phone&&{phone:t.phone}}}(e),a=await this.validateBillingAddress(t);return s(a)?i(o(a)):n(a).isValid?r(t):i(this.createValidationError([...n(a).errors]));case"shipping":const c=function(e){const t=ve.parse(e);return{firstName:t.firstName,lastName:t.lastName,address1:t.address1,city:t.city,state:t.state,postcode:t.postcode,country:t.country,...void 0!==t.company&&{company:t.company},...void 0!==t.address2&&{address2:t.address2},...void 0!==t.email&&{email:t.email},...void 0!==t.phone&&{phone:t.phone}}}(e),d=await this.validateShippingAddress(c);return s(d)?i(o(d)):n(d).isValid?r(c):i(this.createValidationError([...n(d).errors]));default:const u=function(e){const t=ye.parse(e);return{firstName:t.firstName,lastName:t.lastName,address1:t.address1,city:t.city,state:t.state,postcode:t.postcode,country:t.country,...void 0!==t.company&&{company:t.company},...void 0!==t.address2&&{address2:t.address2},...void 0!==t.email&&{email:t.email},...void 0!==t.phone&&{phone:t.phone}}}(e),l=await this.validateAddress(u);return s(l)?i(o(l)):n(l).isValid?r(u):i(this.createValidationError([...n(l).errors]))}}catch(a){return i(w.validationError(`Failed to parse ${t} address`,a))}}convertToBillingAddress(e,t){return{...e,email:t}}convertToShippingAddress(e){const{email:t,...r}=e;return r}buildFieldRequirements(e,t){const r={firstName:!0,lastName:!0,company:!1,address1:!0,address2:!1,city:!0,state:t.stateRequired,postcode:t.postcodeRequired,country:!0,email:"billing"===e.addressType,phone:!1},i={};e.fieldRequirements&&Object.assign(i,e.fieldRequirements),e.checkoutRules&&(e.checkoutRules.requireCompanyName&&(i.company=!0),e.checkoutRules.requirePhoneNumber&&(i.phone=!0));return{...r,...i}}validateRequiredFields(e,t,r){!t.firstName||e.firstName&&e.firstName.trim()||r.push("First name is required"),!t.lastName||e.lastName&&e.lastName.trim()||r.push("Last name is required"),!t.company||e.company&&e.company.trim()||r.push("Company name is required"),!t.address1||e.address1&&e.address1.trim()||r.push("Street address is required"),!t.address2||e.address2&&e.address2.trim()||r.push("Address line 2 is required"),!t.city||e.city&&e.city.trim()||r.push("City is required"),!t.state||e.state&&e.state.trim()||r.push("State/Province is required"),!t.postcode||e.postcode&&e.postcode.trim()||r.push("Postal/ZIP code is required"),!t.country||e.country&&e.country.trim()||r.push("Country is required"),!t.email||e.email&&e.email.trim()||r.push("Email address is required"),!t.phone||e.phone&&e.phone.trim()||r.push("Phone number is required")}validateFieldFormats(e,t,r,i){if(e.postcode&&t.postcodePattern){new RegExp(t.postcodePattern).test(e.postcode)||r.push(`Invalid postal/ZIP code format for ${t.name}`)}if(e.phone&&t.phonePattern){new RegExp(t.phonePattern).test(e.phone)||i.push(`Phone number format may be invalid for ${t.name}`)}if(e.firstName&&e.firstName.length<2&&r.push("First name must be at least 2 characters"),e.lastName&&e.lastName.length<2&&r.push("Last name must be at least 2 characters"),e.address1&&e.address1.length<5&&r.push("Street address must be at least 5 characters"),e.city&&e.city.length<2&&r.push("City must be at least 2 characters"),e.email){/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.email)||r.push("Invalid email address format")}}capitalizeWords(e){return e.toLowerCase().replace(/\b\w/g,e=>e.toUpperCase())}formatPostcode(e,t){const r=e.replace(/\s+/g,"").toUpperCase();switch(t.code){case"CA":return 6===r.length?`${r.slice(0,3)} ${r.slice(3)}`:e;case"GB":return r.length>=5?`${r.slice(0,-3)} ${r.slice(-3)}`:e;case"NL":return 6===r.length?`${r.slice(0,4)} ${r.slice(4)}`:e;default:return e}}createValidationError(e){return{code:"VALIDATION_ERROR",message:"Address validation failed",details:{errors:e},timestamp:new Date}}}new Se;class be{constructor(e,t,r){this.client=e,this.cache=t,this.config=r}async getShippingRates(e){try{if(!this.isShippingAvailable(e.destination.country))return i(w.validationError("Shipping not available to this destination",{country:e.destination.country}));const t=this.generateCacheKey(e),a=await this.cache.get(t);if(a.success&&a.data)return r(a.data);const c=await this.client.post("/wp-json/wc/v3/shipping/rates",{destination:{country:e.destination.country,state:e.destination.state,postcode:e.destination.postcode,city:e.destination.city},items:e.cartItems,cart_total:e.cartTotal,currency:e.currency});if(s(c))return i(w.apiError("Failed to fetch shipping rates",500,o(c)));const d=n(c).data,u={rates:d.rates||[],zones:d.zones||[],defaultRate:d.default_rate,freeShippingThreshold:d.free_shipping_threshold,estimatedDelivery:d.estimated_delivery};return await this.cache.set(t,u,60*this.config.cacheTimeout),r(u)}catch(t){return i(w.apiError("Shipping rate calculation failed",500,t))}}async getShippingZones(e){try{const t=`shipping-zones:${e}`,a=await this.cache.get(t);if(a.success&&a.data)return r(a.data);const o=await this.client.get("/wp-json/wc/v3/shipping/zones",{country:e.toUpperCase()});if(s(o))return i(n(o));const c=n(o).data||[];return await this.cache.set(t,c,60*this.config.cacheTimeout),r(c)}catch(t){return i(w.apiError("Failed to fetch shipping zones",500,t))}}async calculateShipping(e,t,a){try{const o=await this.client.post("/wp-json/wc/v3/shipping/calculate",{method_id:e.methodId,zone_id:e.zoneId,destination:{country:t.country,state:t.state,postcode:t.postcode,city:t.city},cart_total:a});if(s(o))return i(n(o));const c=n(o);return r({selectedMethod:e,shippingCost:c.cost||0,shippingTax:c.tax||0,estimatedDelivery:c.estimated_delivery,trackingAvailable:c.tracking_available||!1})}catch(o){return i(w.apiError("Shipping calculation failed",500,o))}}checkFreeShipping(e,t){return!!t&&e>=t}getCheapestRate(e){return 0===e.length?null:e.reduce((e,t)=>t.cost<e.cost?t:e)}getFastestRate(e){if(0===e.length)return null;const t=["overnight","expedited","flat_rate","table_rate","local_pickup","free_shipping"];for(const r of t){const t=e.find(e=>e.method===r);if(t)return t}return e[0]}filterRatesByMethod(e,t){return e.filter(e=>e.method===t)}groupRatesByZone(e,t){const r={};return t.forEach(t=>{r[t.id]=t.methods.filter(t=>e.some(e=>e.id===t.id))}),r}validateShippingSelection(e,t){return t.some(t=>t.id===e.methodId)}updateOrderTotalsWithShipping(e,t){return{...e,shipping:t.shippingCost,shippingTax:t.shippingTax,total:e.subtotal+e.tax+t.shippingCost+t.shippingTax+e.fees+e.feesTax-e.discount}}estimateDeliveryDate(e,t=new Date){if(!e.estimatedDelivery)return null;const r=e.estimatedDelivery.match(/(\d+)-?(\d+)?\s*(business\s+)?days?/i);if(!r)return null;const i=parseInt(r[1]),a=r[2]?parseInt(r[2]):i,s=!!r[3];let n=new Date(t),o=a;if(s){let e=0;for(;e<o;)n.setDate(n.getDate()+1),0!==n.getDay()&&6!==n.getDay()&&e++}else n.setDate(n.getDate()+o);return n}async clearShippingCache(){try{return await this.cache.invalidatePattern("shipping-"),r(void 0)}catch(e){return i(w.cacheError("Failed to clear shipping cache",e))}}isShippingAvailable(e){return!!this.config.enabled&&!this.config.restrictedCountries.includes(e.toUpperCase())}generateCacheKey(e){const t={country:e.destination.country,state:e.destination.state,postcode:e.destination.postcode,itemCount:e.cartItems.length,total:e.cartTotal,currency:e.currency};return`shipping-rates:${Buffer.from(JSON.stringify(t)).toString("base64")}`}}const Ce={enabled:!0,calculateTax:!0,defaultCountry:"US",restrictedCountries:[],cacheTimeout:15};class Ie{constructor(e,t,r){this.client=e,this.cache=t,this.config=r}async getAvailablePaymentMethods(e,t=this.config.currency,a){try{const c=`payment-methods:${e}:${t}:${a||"default"}`,d=await this.cache.get(c);if(d.success&&d.data)return r(d.data);const u=await this.client.get("/wp-json/wc/v3/payment_gateways",{amount:e.toString(),currency:t,country:a?.toUpperCase()});if(s(u))return i(o(u));const l=n(u).data,h={availableMethods:l.payment_gateways||[],defaultMethod:l.default_gateway,minimumAmounts:l.minimum_amounts||{},currency:l.currency||t};return await this.cache.set(c,h,60*this.config.cacheTimeout),r(h)}catch(c){return i(w.apiError("Failed to fetch payment methods",500,c))}}async initializePayment(e){try{const t=await this.getAvailablePaymentMethods(e.amount,e.currency);if(s(t))return i(o(t));const a=n(t).availableMethods.find(t=>t.id===e.paymentMethodId);if(!a||!a.enabled)return i(w.validationError("Selected payment method is not available",{methodId:e.paymentMethodId}));const c=await this.client.post("/wp-json/wc/v3/payments/initialize",{payment_method:e.paymentMethodId,order_id:e.orderId,amount:e.amount,currency:e.currency,return_url:e.returnUrl,cancel_url:e.cancelUrl,metadata:e.metadata});if(s(c))return i(o(c));const d=n(c).data;return r({paymentId:d.payment_id,redirectUrl:d.redirect_url,requiresRedirect:d.requires_redirect||!1,clientSecret:d.client_secret,paymentIntentId:d.payment_intent_id,instructions:d.instructions,expiresAt:d.expires_at?new Date(d.expires_at):void 0})}catch(t){return i(w.apiError("Payment initialization failed",500,t))}}async checkPaymentStatus(e){try{const t=await this.client.get(`/wp-json/wc/v3/payments/${e}/status`);if(s(t))return i(o(t));const a=n(t).data;return r({paymentId:a.payment_id,status:a.status,transactionId:a.transaction_id,failureReason:a.failure_reason,redirectUrl:a.redirect_url,nextAction:a.next_action?{type:a.next_action.type,url:a.next_action.url,data:a.next_action.data}:void 0})}catch(t){return i(w.apiError("Payment status check failed",500,t))}}async handlePaymentCallback(e){try{if(e.signature){if(!(await this.verifyCallbackSignature(e)))return i(w.authError("Invalid payment callback signature"))}const t=await this.client.post("/wp-json/wc/v3/payments/callback",{payment_id:e.paymentId,order_id:e.orderId,status:e.status,transaction_id:e.transactionId,signature:e.signature,metadata:e.metadata});if(s(t))return i(o(t));const a=n(t).data;return r({paymentId:a.payment_id,status:a.status,transactionId:a.transaction_id,failureReason:a.failure_reason,redirectUrl:a.redirect_url})}catch(t){return i(w.apiError("Payment callback processing failed",500,t))}}async cancelPayment(e,t){try{const a=await this.client.post(`/wp-json/wc/v3/payments/${e}/cancel`,{reason:t});return s(a)?i(o(a)):r(void 0)}catch(a){return i(w.apiError("Payment cancellation failed",500,a))}}async validatePaymentMethod(e,t,a=this.config.currency){try{const c=[],d=[];this.config.supportedMethods.includes(e)||c.push(`Payment method "${e}" is not supported`),t<this.config.minimumAmount&&c.push(`Amount is below minimum (${this.config.minimumAmount} ${a})`),this.config.maximumAmount&&t>this.config.maximumAmount&&c.push(`Amount exceeds maximum (${this.config.maximumAmount} ${a})`);const u=await this.getAvailablePaymentMethods(t,a);if(s(u))return i(o(u));const l=n(u),h=l.availableMethods.find(t=>t.id===e);if(h)if(h.enabled){const r=l.minimumAmounts[e];r&&t<r&&c.push(`Amount is below minimum for ${h.title} (${r} ${a})`),h.description&&d.push(h.description)}else c.push(`Payment method "${e}" is currently disabled`);else c.push(`Payment method "${e}" is not available`);return r({isValid:0===c.length,errors:c,warnings:d})}catch(c){return i(w.validationError("Payment method validation failed",c))}}generateRedirectUrl(e,t){const r=new URL(e);return Object.entries(t).forEach(([e,t])=>{r.searchParams.set(e,t)}),r.toString()}parseCallbackUrl(e){const t=new URL(e),r={};return t.searchParams.forEach((e,t)=>{r[t]=e}),r}requiresRedirect(e){return["paypal","stripe_checkout","bank_transfer","cash_on_delivery"].includes(e)}getPaymentMethodDisplay(e){return{title:e.title||e.id,description:e.description||"",icon:e.icon,acceptedCards:e.acceptedCards}}filterPaymentMethods(e,t){return e.filter(e=>(void 0===t.enabled||e.enabled===t.enabled)&&(!(t.minAmount&&e.minimumAmount&&t.minAmount<e.minimumAmount)&&(!(t.country&&e.supportedCountries&&!e.supportedCountries.includes(t.country.toUpperCase()))&&!(t.currency&&e.supportedCurrencies&&!e.supportedCurrencies.includes(t.currency.toUpperCase())))))}async clearPaymentCache(){try{return await this.cache.invalidatePattern("payment-"),r(void 0)}catch(e){return i(w.cacheError("Failed to clear payment cache",e))}}async verifyCallbackSignature(e){try{return!0}catch(t){return!1}}}const xe={enabled:!0,testMode:!0,supportedMethods:["stripe","paypal","bank_transfer","cash_on_delivery"],minimumAmount:1,currency:"USD",returnUrl:"/checkout/payment/return",cancelUrl:"/checkout/payment/cancel",cacheTimeout:10};class Ee{constructor(e,t,r){this.addressManager=e,this.shippingService=t,this.paymentService=r}async validateCheckout(e){try{const t=[],a=[],c=[],d=[],u=[],l=await this.validateBillingAddress(e);if(s(l))return i(o(l));if(t.push(n(l)),!e.checkoutSession.useShippingAsBilling){const r=await this.validateShippingAddress(e);if(s(r))return i(o(r));t.push(n(r))}if(e.checkoutSession.selectedShippingMethod){const r=await this.validateShippingMethod(e);if(s(r))return i(o(r));t.push(n(r))}if(e.checkoutSession.selectedPaymentMethod){const r=await this.validatePaymentMethod(e);if(s(r))return i(o(r));t.push(n(r))}const h=await this.validateCart(e);if(s(h))return i(o(h));t.push(n(h));const p=await this.validateOrderTotals(e);if(s(p))return i(o(p));t.push(n(p));const m=t.every(e=>e.isValid);t.forEach(e=>{e.isValid||a.push(...e.errors),c.push(...e.warnings)});const g=t.some(e=>"address"===e.component&&!e.isValid),y=t.some(e=>"payment"===e.component&&!e.isValid),f=t.some(e=>"cart"===e.component&&!e.isValid);g&&d.push("Address information is incomplete or invalid"),y&&d.push("Payment method is not valid or available"),f&&d.push("Some items are out of stock or unavailable"),this.generateRecommendations(t,u);return r({isValid:m,canProceed:m&&0===d.length,validationResults:t,criticalErrors:a,warnings:c,blockers:d,recommendations:u})}catch(t){return i(w.validationError("Checkout validation failed",t))}}async validateBillingAddress(e){try{const t=e.checkoutSession.billingAddress;if(!t)return r({component:"address",isValid:!1,errors:["Billing address is required"],warnings:[]});const a={addressType:"billing",isGuestCheckout:e.isGuestCheckout,checkoutRules:e.validationRules,fieldRequirements:{email:e.isGuestCheckout||e.validationRules.requireEmail}},c=await this.addressManager.validateAddressWithContext(t,a);if(s(c))return i(o(c));const d=n(c);return r({component:"address",isValid:d.isValid,errors:d.errors,warnings:d.warnings,metadata:{addressType:"billing"}})}catch(t){return i(w.validationError("Billing address validation failed",t))}}async validateShippingAddress(e){try{const t=e.checkoutSession.shippingAddress;if(!t)return r({component:"address",isValid:!1,errors:["Shipping address is required"],warnings:[]});const a={addressType:"shipping",isGuestCheckout:e.isGuestCheckout,checkoutRules:e.validationRules},c=await this.addressManager.validateAddressWithContext(t,a);if(s(c))return i(o(c));const d=n(c);return r({component:"address",isValid:d.isValid,errors:d.errors,warnings:d.warnings,metadata:{addressType:"shipping"}})}catch(t){return i(w.validationError("Shipping address validation failed",t))}}async validateShippingMethod(e){try{const t=e.checkoutSession.selectedShippingMethod,a=e.checkoutSession.useShippingAsBilling?e.checkoutSession.billingAddress:e.checkoutSession.shippingAddress;if(!t||!a)return r({component:"shipping",isValid:!1,errors:["Shipping method and address are required"],warnings:[]});const c=await this.shippingService.getShippingRates({destination:a,cartItems:e.cart.items.map(e=>({productId:e.productId,variationId:e.variationId,quantity:e.quantity,weight:e.weight,dimensions:e.dimensions})),cartTotal:e.cart.totals.total,currency:e.cart.currency});if(s(c))return i(o(c));const d=n(c);return r(this.shippingService.validateShippingSelection(t,d.rates)?{component:"shipping",isValid:!0,errors:[],warnings:[],metadata:{selectedMethod:t}}:{component:"shipping",isValid:!1,errors:["Selected shipping method is no longer available"],warnings:[]})}catch(t){return i(w.validationError("Shipping method validation failed",t))}}async validatePaymentMethod(e){try{const t=e.checkoutSession.selectedPaymentMethod;if(!t)return r({component:"payment",isValid:!1,errors:["Payment method is required"],warnings:[]});const a=await this.paymentService.validatePaymentMethod(t.id,e.cart.totals.total,e.cart.currency);if(s(a))return i(o(a));const c=n(a);return r({component:"payment",isValid:c.isValid,errors:c.errors,warnings:c.warnings,metadata:{selectedMethod:t}})}catch(t){return i(w.validationError("Payment method validation failed",t))}}async validateCart(e){try{const t=e.cart,i=[],a=[];0===t.items.length&&i.push("Cart is empty"),e.validationRules.minimumOrderAmount&&t.totals.total<e.validationRules.minimumOrderAmount&&i.push(`Minimum order amount is ${e.validationRules.minimumOrderAmount}`),e.validationRules.maximumOrderAmount&&t.totals.total>e.validationRules.maximumOrderAmount&&i.push(`Maximum order amount is ${e.validationRules.maximumOrderAmount}`);return r({component:"cart",isValid:0===i.length,errors:i,warnings:a,metadata:{itemCount:t.items.length,total:t.totals.total}})}catch(t){return i(w.validationError("Cart validation failed",t))}}async validateOrderTotals(e){try{const t=e.cart.totals,i=[],a=[];t.total<0&&i.push("Order total cannot be negative"),t.subtotal<0&&i.push("Subtotal cannot be negative"),t.tax<0&&i.push("Tax amount cannot be negative");const s=t.subtotal+t.tax+t.shipping+t.shippingTax+t.fees+t.feesTax-t.discount;Math.abs(s-t.total)>.01&&i.push("Order total calculation is inconsistent"),t.total>1e5&&a.push("Order total is unusually high");return r({component:"totals",isValid:0===i.length,errors:i,warnings:a,metadata:{calculatedTotal:s,actualTotal:t.total}})}catch(t){return i(w.validationError("Order totals validation failed",t))}}async validateStep(e,t){try{const a=[];switch(e){case 1:const r=await this.validateBillingAddress(t);if(s(r))return i(o(r));if(a.push(n(r)),!t.checkoutSession.useShippingAsBilling){const e=await this.validateShippingAddress(t);if(s(e))return i(o(e));a.push(n(e))}break;case 2:if(t.checkoutSession.selectedShippingMethod){const e=await this.validateShippingMethod(t);if(s(e))return i(o(e));a.push(n(e))}break;case 3:if(t.checkoutSession.selectedPaymentMethod){const e=await this.validatePaymentMethod(t);if(s(e))return i(o(e));a.push(n(e))}break;case 4:return this.validateCheckout(t);default:return i(w.validationError(`Invalid checkout step: ${e}`))}const c=a.every(e=>e.isValid),d=a.flatMap(e=>e.errors),u=a.flatMap(e=>e.warnings);return r({isValid:c,canProceed:c,validationResults:a,criticalErrors:d,warnings:u,blockers:c?[]:["Step validation failed"],recommendations:[]})}catch(a){return i(w.validationError("Step validation failed",a))}}async validateField(e,t,a){try{const s=[],n=[];switch(e){case"email":if("string"==typeof t){/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)||s.push("Invalid email format")}else s.push("Email must be a string");break;case"phone":if("string"==typeof t&&t.length>0){/^[\+]?[\d\s\-\(\)]+$/.test(t)||s.push("Invalid phone number format")}break;case"postcode":if("string"==typeof t&&t.length>0){const e=a.checkoutSession.billingAddress?.country;if(e){const r=this.addressManager.getCountryConfig(e);if(r?.postcodePattern){new RegExp(r.postcodePattern).test(t)||s.push(`Invalid postal code format for ${r.name}`)}}}break;default:return i(w.validationError(`Unknown field: ${e}`))}return r({component:"address",isValid:0===s.length,errors:s,warnings:n,metadata:{fieldName:e,value:t}})}catch(s){return i(w.validationError("Field validation failed",s))}}generateRecommendations(e,t){e.filter(e=>"address"===e.component).some(e=>e.warnings.length>0)&&t.push("Review address information for accuracy");e.filter(e=>"shipping"===e.component).length>0&&t.push("Consider different shipping options for better rates");e.filter(e=>"payment"===e.component).some(e=>e.warnings.length>0)&&t.push("Check payment method details");e.filter(e=>"cart"===e.component).some(e=>e.warnings.length>0)&&t.push("Review cart items and quantities")}}class ke{constructor(){this.rules={}}minimumOrderAmount(e){return this.rules={...this.rules,minimumOrderAmount:e},this}maximumOrderAmount(e){return this.rules={...this.rules,maximumOrderAmount:e},this}requireEmail(e=!0){return this.rules={...this.rules,requireEmail:e},this}requirePhoneNumber(e=!0){return this.rules={...this.rules,requirePhoneNumber:e},this}requireCompanyName(e=!0){return this.rules={...this.rules,requireCompanyName:e},this}requiredFields(e){return this.rules={...this.rules,requiredFields:e},this}returnUrl(e){return this.rules={...this.rules,returnUrl:e},this}cancelUrl(e){return this.rules={...this.rules,cancelUrl:e},this}build(){const e={requireShippingAddress:this.rules.requireShippingAddress??!0,requireBillingAddress:this.rules.requireBillingAddress??!0,requirePhoneNumber:this.rules.requirePhoneNumber??!1,requireCompanyName:this.rules.requireCompanyName??!1,allowGuestCheckout:this.rules.allowGuestCheckout??!0,restrictedCountries:this.rules.restrictedCountries??[],requiredFields:this.rules.requiredFields??[]};return void 0!==this.rules.requireEmail&&(e.requireEmail=this.rules.requireEmail),void 0!==this.rules.minimumOrderAmount&&(e.minimumOrderAmount=this.rules.minimumOrderAmount),void 0!==this.rules.maximumOrderAmount&&(e.maximumOrderAmount=this.rules.maximumOrderAmount),void 0!==this.rules.returnUrl&&(e.returnUrl=this.rules.returnUrl),void 0!==this.rules.cancelUrl&&(e.cancelUrl=this.rules.cancelUrl),e}}class ze{constructor(e,t,r,i,a,s={}){this.paymentService=r,this.validationService=i,this.config=a,this.eventHandlers=s,this.sessionId=this.generateSessionId(),this.flowState=this.initializeFlowState()}async initializeCheckout(e,t=!1){try{const i={id:this.sessionId,cartId:e.id,isGuestCheckout:t,orderTotals:e.totals,flow:createEmptyCheckoutFlow(),expiresAt:new Date(Date.now()+60*this.config.sessionTimeout*1e3),createdAt:new Date,updatedAt:new Date};return this.flowState={currentStep:1,completedSteps:[],availableSteps:this.buildAvailableSteps(e),canProceed:!1,canGoBack:!1,session:i},this.config.persistSession&&await this.persistSession(),r(this.flowState)}catch(a){return i(w.validationError("Failed to initialize checkout flow",a))}}async nextStep(e){try{const t=this.flowState.currentStep,a=await this.validateCurrentStep(e);if(s(a))return i(o(a));const c=n(a);if(!c.canProceed)return r({success:!1,newStep:t,previousStep:t,validationResult:c,errors:c.criticalErrors,blockers:c.blockers});const d=t+1;if(d>this.flowState.availableSteps.length)return this.completeCheckout(e);const u=this.flowState.currentStep;return this.flowState={...this.flowState,currentStep:d,completedSteps:[...this.flowState.completedSteps,t],canProceed:!1,canGoBack:!0,validationResult:c},this.config.persistSession&&await this.persistSession(),this.eventHandlers.onStepChange?.(d,u),this.eventHandlers.onStepComplete?.(t),r({success:!0,newStep:d,previousStep:u,validationResult:c,errors:[],blockers:[]})}catch(t){return i(w.validationError("Failed to advance to next step",t))}}async previousStep(){try{const e=this.flowState.currentStep;if(e<=1||!this.flowState.canGoBack)return i(w.validationError("Cannot go back from current step"));const t=e-1;return this.flowState={...this.flowState,currentStep:t,completedSteps:this.flowState.completedSteps.filter(t=>t!==e),canProceed:!0,canGoBack:t>1},this.config.persistSession&&await this.persistSession(),this.eventHandlers.onStepChange?.(t,e),r({success:!0,newStep:t,previousStep:e,errors:[],blockers:[]})}catch(e){return i(w.validationError("Failed to go back to previous step",e))}}async goToStep(e,t){try{const a=this.flowState.currentStep;if(e<1||e>this.flowState.availableSteps.length)return i(w.validationError(`Invalid step: ${e}`));if(e>a)for(let c=a;c<e;c++){const e=await this.validateStep(c,t);if(s(e))return i(o(e));const d=n(e);if(!d.canProceed)return r({success:!1,newStep:c,previousStep:a,validationResult:d,errors:d.criticalErrors,blockers:d.blockers})}return this.flowState={...this.flowState,currentStep:e,completedSteps:e>a?[...this.flowState.completedSteps,...Array.from({length:e-a},(e,t)=>a+t)]:this.flowState.completedSteps.filter(t=>t<e),canGoBack:e>1},this.config.persistSession&&await this.persistSession(),this.eventHandlers.onStepChange?.(e,a),r({success:!0,newStep:e,previousStep:a,errors:[],blockers:[]})}catch(a){return i(w.validationError("Failed to jump to step",a))}}async updateSession(e,t){try{this.flowState={...this.flowState,session:{...this.flowState.session,...e,updatedAt:new Date}};const i=await this.validateCurrentStep(t);if(a(i)){const e=n(i);this.flowState={...this.flowState,canProceed:e.canProceed,validationResult:e}}return this.config.persistSession&&await this.persistSession(),r(this.flowState)}catch(s){return i(w.validationError("Failed to update checkout session",s))}}async validateCurrentStep(e){return this.validateStep(this.flowState.currentStep,e)}async validateStep(e,t){try{const r={checkoutSession:this.flowState.session,cart:t,validationRules:this.config.validationRules,isGuestCheckout:this.flowState.session.isGuestCheckout??!1,currentStep:e,skipOptionalValidations:this.config.allowSkipOptional};return this.validationService.validateStep(e,r)}catch(r){return i(w.validationError("Step validation failed",r))}}async completeCheckout(e){try{const t={checkoutSession:this.flowState.session,cart:e,validationRules:this.config.validationRules,isGuestCheckout:this.flowState.session.isGuestCheckout??!1,currentStep:this.flowState.currentStep},c=await this.validationService.validateCheckout(t);if(s(c))return i(o(c));const d=n(c);if(!d.canProceed)return this.eventHandlers.onValidationError?.(d.criticalErrors),r({success:!1,newStep:this.flowState.currentStep,previousStep:this.flowState.currentStep,validationResult:d,errors:d.criticalErrors,blockers:d.blockers});const u=await this.createOrder(e);if(s(u))return i(o(u));const l=n(u);if(this.flowState.session.selectedPaymentMethod){const e=await this.initializePayment(l);if(a(e)){const t=n(e);return r({success:!0,orderId:l.id.toString(),redirectUrl:t.redirectUrl,paymentStatus:"pending",requiresRedirect:t.requiresRedirect,clientSecret:t.clientSecret,paymentIntentId:t.paymentIntentId})}}return this.flowState={...this.flowState,currentStep:this.flowState.availableSteps.length+1,completedSteps:[...this.flowState.completedSteps,this.flowState.currentStep],canProceed:!1,canGoBack:!1},this.eventHandlers.onCheckoutComplete?.(l),r({success:!0,newStep:this.flowState.currentStep,previousStep:this.flowState.currentStep-1,errors:[],blockers:[]})}catch(t){const e=w.validationError("Checkout completion failed",t);return this.eventHandlers.onCheckoutError?.(e),i(e)}}getFlowState(){return this.flowState}getCurrentStep(){const e=this.flowState.currentStep-1;return this.flowState.availableSteps[e]||null}isStepCompleted(e){return this.flowState.completedSteps.includes(e)}async resetFlow(){try{return this.flowState=this.initializeFlowState(),this.sessionId=this.generateSessionId(),this.config.persistSession&&await this.clearPersistedSession(),r(void 0)}catch(e){return i(w.validationError("Failed to reset checkout flow",e))}}initializeFlowState(){return{currentStep:1,completedSteps:[],availableSteps:[],canProceed:!1,canGoBack:!1,session:{id:this.sessionId,cartId:"",isGuestCheckout:!1,useShippingAsBilling:!0,orderNotes:"",termsAccepted:!1,newsletterOptIn:!1,orderTotals:{subtotal:0,tax:0,shipping:0,shippingTax:0,discount:0,fees:0,feesTax:0,total:0,currency:"USD"},flow:{steps:[],currentStep:"cart_review",canProceed:!1,canGoBack:!1,progress:{current:1,total:4,percentage:25}},expiresAt:new Date(Date.now()+36e5),createdAt:new Date,updatedAt:new Date}}}buildAvailableSteps(e){const t=[];t.push({type:"address",title:"Billing & Shipping",description:"Enter your billing and shipping information",completed:!1,valid:!1,errors:[]});return e.items.length>0&&t.push({type:"shipping",title:"Shipping Method",description:"Choose your shipping method",completed:!1,valid:!1,errors:[]}),t.push({type:"payment",title:"Payment",description:"Choose your payment method",completed:!1,valid:!1,errors:[]}),t.push({type:"review",title:"Review Order",description:"Review your order before placing it",completed:!1,valid:!1,errors:[]}),t}async createOrder(e){try{return r({id:this.generateOrderId(),number:`ORDER-${Date.now()}`,status:"pending",currency:e.currency,total:e.totals.total,subtotal:e.totals.subtotal,totalTax:e.totals.tax,shippingTotal:e.totals.shipping,shippingTax:e.totals.shippingTax,discountTotal:e.totals.discount,feeTotal:e.totals.fees,feeTax:e.totals.feeTax,billingAddress:this.flowState.session.billingAddress,shippingAddress:this.flowState.session.useShippingAsBilling?this.flowState.session.billingAddress:this.flowState.session.shippingAddress,paymentMethod:this.flowState.session.selectedPaymentMethod?.id||"",shippingMethod:this.flowState.session.selectedShippingMethod?.methodId||"",orderNotes:this.flowState.session.orderNotes,lineItems:e.items.map((e,t)=>({id:t+1,productId:e.productId,variationId:e.variationId,quantity:e.quantity,price:e.price,total:e.total,subtotal:e.price*e.quantity,totalTax:0,subtotalTax:0,name:e.name,sku:e.sku,meta:[]})),createdAt:new Date,updatedAt:new Date})}catch(t){return i(w.apiError("Order creation failed",500,t))}}async initializePayment(e){try{if(!this.flowState.session.selectedPaymentMethod)return r({});const t={paymentMethodId:this.flowState.session.selectedPaymentMethod.id,orderId:e.id,amount:e.total,currency:e.currency,returnUrl:this.config.validationRules.returnUrl||"/checkout/success",cancelUrl:this.config.validationRules.cancelUrl||"/checkout/cancel"},a=await this.paymentService.initializePayment(t);if(s(a))return i(o(a));return r({redirectUrl:n(a).redirectUrl})}catch(t){return i(w.apiError("Payment initialization failed",500,t))}}async persistSession(){"undefined"!=typeof window&&localStorage.setItem(`woo-checkout-session-${this.sessionId}`,JSON.stringify(this.flowState))}async clearPersistedSession(){"undefined"!=typeof window&&localStorage.removeItem(`woo-checkout-session-${this.sessionId}`)}generateSessionId(){return`checkout-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateOrderId(){return Date.now()}}const _e={steps:["address","shipping","payment","review"],allowSkipOptional:!1,persistSession:!0,sessionTimeout:30,autoAdvance:!1,validationRules:{minimumOrderAmount:0,requireEmail:!0,requirePhoneNumber:!1,requireCompanyName:!1,requiredFields:[]}};class Ae{constructor(e,t,r){this.client=e,this.cache=t,this.config=r}async createOrder(e){try{const t=await this.validateOrderCreation(e);if(s(t))return i(o(t));if(this.config.autoUpdateInventory){const t=await this.reserveInventory(e.cart);if(s(t))return i(o(t))}const a=this.buildOrderData(e),c=await this.client.post("/wp-json/wc/v3/orders",a);if(s(c))return this.config.autoUpdateInventory&&await this.releaseInventory(e.cart),i(o(c));const d=n(c).data,u=this.mapOrderResponse(d);this.config.autoUpdateInventory&&await this.updateInventory({orderId:u.id.toString(),items:e.cart.items.map(e=>({productId:e.productId,variationId:e.variationId,quantity:e.quantity,operation:"decrease"}))}),await this.cache.set(`order:${u.id}`,u,60*this.config.cacheTimeout);return r({order:u,requiresPayment:u.total>0&&"pending"===u.status,paymentUrl:d.payment_url,confirmationUrl:`/order-confirmation/${u.id}`})}catch(t){return i(w.apiError("Order creation failed",500,t))}}async getOrder(e){try{const t=await this.cache.get(`order:${e}`);if(t.success&&t.data)return r(t.data);const a=await this.client.get(`/wp-json/wc/v3/orders/${e}`);if(s(a))return i(o(a));const c=n(a).data,d=this.mapOrderResponse(c);return await this.cache.set(`order:${e}`,d,60*this.config.cacheTimeout),r(d)}catch(t){return i(w.apiError("Failed to fetch order",500,t))}}async updateOrderStatus(e){try{const t=await this.client.put(`/wp-json/wc/v3/orders/${e.orderId}`,{status:e.status,customer_note:e.note,notify_customer:e.notifyCustomer||!1});if(s(t))return i(o(t));const a=n(t).data,c=this.mapOrderResponse(a);return await this.cache.set(`order:${c.id}`,c,60*this.config.cacheTimeout),r(c)}catch(t){return i(w.apiError("Failed to update order status",500,t))}}async confirmOrder(e){try{const t=await this.getOrder(e.orderId);if(s(t))return i(o(t));n(t);const a={status:"processing",transaction_id:e.transactionId,date_paid:(new Date).toISOString()};e.paymentStatus&&(a.payment_status=e.paymentStatus);const c=await this.client.put(`/wp-json/wc/v3/orders/${e.orderId}`,a);if(s(c))return i(o(c));const d=n(c).data,u=this.mapOrderResponse(d);return await this.cache.set(`order:${u.id}`,u,60*this.config.cacheTimeout),this.config.sendConfirmationEmail&&await this.sendOrderConfirmationEmail(u),r(u)}catch(t){return i(w.apiError("Order confirmation failed",500,t))}}async cancelOrder(e,t){try{const a=await this.getOrder(e);if(s(a))return i(o(a));const c=n(a);if(!["pending","processing","on-hold"].includes(c.status))return i(w.validationError(`Cannot cancel order with status: ${c.status}`));const d=await this.client.put(`/wp-json/wc/v3/orders/${e}`,{status:"cancelled",customer_note:t||"Order cancelled by customer"});if(s(d))return i(o(d));const u=n(d).data,l=this.mapOrderResponse(u);return this.config.autoUpdateInventory&&await this.updateInventory({orderId:l.id,items:l.lineItems.map(e=>({productId:e.productId,variationId:e.variationId,quantity:e.quantity,operation:"increase"}))}),await this.cache.set(`order:${l.id}`,l,60*this.config.cacheTimeout),r(l)}catch(a){return i(w.apiError("Order cancellation failed",500,a))}}async searchOrders(e){try{const t={};e.status&&(t.status=e.status),e.customerId&&(t.customer=e.customerId),e.customerEmail&&(t.customer_email=e.customerEmail),e.dateFrom&&(t.after=e.dateFrom.toISOString()),e.dateTo&&(t.before=e.dateTo.toISOString()),e.paymentMethod&&(t.payment_method=e.paymentMethod),e.limit&&(t.per_page=e.limit.toString()),e.offset&&(t.offset=e.offset.toString());const a=await this.client.get("/wp-json/wc/v3/orders",t);if(s(a))return i(o(a));const c=n(a).data.map(e=>this.mapOrderResponse(e));let d=c;return(e.minAmount||e.maxAmount)&&(d=c.filter(t=>!(e.minAmount&&t.total<e.minAmount)&&!(e.maxAmount&&t.total>e.maxAmount))),r(d)}catch(t){return i(w.apiError("Order search failed",500,t))}}async getOrderNotes(e){try{const t=await this.client.get(`/wp-json/wc/v3/orders/${e}/notes`);if(s(t))return i(o(t));const a=n(t).data;return r(a.map(e=>e.note))}catch(t){return i(w.apiError("Failed to fetch order notes",500,t))}}async addOrderNote(e,t,a=!1){try{const n=await this.client.post(`/wp-json/wc/v3/orders/${e}/notes`,{note:t,customer_note:a});return s(n)?i(o(n)):r(void 0)}catch(n){return i(w.apiError("Failed to add order note",500,n))}}generateOrderNumber(){const e=Date.now(),t=Math.random().toString(36).substr(2,4).toUpperCase();return`${this.config.orderNumberPrefix}${e}${t}${this.config.orderNumberSuffix||""}`}async validateOrderCreation(e){try{const{cart:t,checkoutSession:a}=e;return 0===t.items.length?i(w.validationError("Cart is empty")):t.totals.total<0?i(w.validationError("Order total cannot be negative")):a.billingAddress?a.useShippingAsBilling||a.shippingAddress?t.totals.total>0&&!a.selectedPaymentMethod?i(w.validationError("Payment method is required")):a.termsAccepted?r(void 0):i(w.validationError("Terms and conditions must be accepted")):i(w.validationError("Shipping address is required")):i(w.validationError("Billing address is required"))}catch(t){return i(w.validationError("Order validation failed",t))}}buildOrderData(e){const{cart:t,checkoutSession:r}=e;return{payment_method:r.selectedPaymentMethod?.id||"",payment_method_title:r.selectedPaymentMethod?.title||"",set_paid:!1,billing:this.mapAddressForAPI(r.billingAddress),shipping:r.useShippingAsBilling?this.mapAddressForAPI(r.billingAddress):this.mapAddressForAPI(r.shippingAddress),line_items:t.items.map(e=>({product_id:e.productId,variation_id:e.variationId||0,quantity:e.quantity,price:e.price,total:e.total.toString()})),shipping_lines:r.selectedShippingMethod?[{method_id:r.selectedShippingMethod.methodId,method_title:r.selectedShippingMethod.title,total:r.selectedShippingMethod.cost.toString()}]:[],customer_note:r.orderNotes||"",status:this.config.defaultStatus,currency:t.currency,customer_id:r.isGuestCheckout?0:void 0,meta_data:[{key:"_woo_headless_checkout_session",value:r.id},{key:"_woo_headless_created",value:(new Date).toISOString()}]}}mapAddressForAPI(e){return{first_name:e.firstName,last_name:e.lastName,company:e.company||"",address_1:e.address1,address_2:e.address2||"",city:e.city,state:e.state,postcode:e.postcode,country:e.country,email:e.email||"",phone:e.phone||""}}mapOrderResponse(e){return{id:e.id.toString(),number:e.number,status:e.status,currency:e.currency,total:parseFloat(e.total),subtotal:parseFloat(e.line_items_subtotal||"0"),totalTax:parseFloat(e.total_tax),shippingTotal:parseFloat(e.shipping_total),shippingTax:parseFloat(e.shipping_tax),discountTotal:parseFloat(e.discount_total),feeTotal:parseFloat(e.fee_total||"0"),feeTax:parseFloat(e.fee_tax||"0"),billingAddress:this.mapAddressFromAPI(e.billing),shippingAddress:this.mapAddressFromAPI(e.shipping),paymentMethod:e.payment_method,shippingMethod:e.shipping_lines[0]?.method_id||"",orderNotes:e.customer_note||"",lineItems:e.line_items.map(e=>({id:e.id.toString(),productId:e.product_id,variationId:e.variation_id||void 0,quantity:e.quantity,price:parseFloat(e.price),total:parseFloat(e.total),name:e.name,sku:e.sku||""})),createdAt:new Date(e.date_created),updatedAt:new Date(e.date_modified)}}mapAddressFromAPI(e){return{firstName:e.first_name,lastName:e.last_name,company:e.company,address1:e.address_1,address2:e.address_2,city:e.city,state:e.state,postcode:e.postcode,country:e.country,email:e.email,phone:e.phone}}async reserveInventory(e){try{return r(void 0)}catch(t){return i(w.apiError("Inventory reservation failed",500,t))}}async releaseInventory(e){try{return r(void 0)}catch(t){return i(w.apiError("Inventory release failed",500,t))}}async updateInventory(e){try{return r(void 0)}catch(t){return i(w.apiError("Inventory update failed",500,t))}}async sendOrderConfirmationEmail(e){try{return r(void 0)}catch(t){return i(w.apiError("Confirmation email failed",500,t))}}}const Te={autoUpdateInventory:!0,sendConfirmationEmail:!0,requirePaymentConfirmation:!0,orderNumberPrefix:"WOO-",defaultStatus:"pending",inventoryHoldMinutes:15,cacheTimeout:30};class Pe{constructor(e,t,r={}){this.flowManager=null,this.currentCart=null,this.config=r,this.addressManager=new Se,this.shippingService=new be(e,t,{...Ce,...r.shipping}),this.paymentService=new Ie(e,t,{...xe,...r.payment}),this.validationService=new Ee(this.addressManager,this.shippingService,this.paymentService),this.orderProcessingService=new Ae(e,t,{...Te,...r.order})}async initializeCheckout(e,t={},r={}){try{this.currentCart=e;const i={..._e,...this.config.flow,validationRules:{..._e.validationRules,...this.config.validation}};this.flowManager=new ze(this.addressManager,this.shippingService,this.paymentService,this.validationService,i,r);const s=await this.flowManager.initializeCheckout(e,t.isGuestCheckout||!1);return a(s)&&t.startStep&&t.startStep>1?this.flowManager.goToStep(t.startStep,e):s}catch(s){return i(w.validationError("Checkout initialization failed",s))}}async updateSession(e){return this.flowManager&&this.currentCart?this.flowManager.updateSession(e,this.currentCart):i(w.validationError("Checkout not initialized"))}async nextStep(){return this.flowManager&&this.currentCart?this.flowManager.nextStep(this.currentCart):i(w.validationError("Checkout not initialized"))}async previousStep(){return this.flowManager?this.flowManager.previousStep():i(w.validationError("Checkout not initialized"))}async goToStep(e){return this.flowManager&&this.currentCart?this.flowManager.goToStep(e,this.currentCart):i(w.validationError("Checkout not initialized"))}getCurrentState(){return this.flowManager?.getFlowState()||null}async validateCurrentStep(){return this.flowManager&&this.currentCart?this.flowManager.validateCurrentStep(this.currentCart):i(w.validationError("Checkout not initialized"))}async completeCheckout(){try{if(!this.flowManager||!this.currentCart)return i(w.validationError("Checkout not initialized"));const e=this.flowManager.getFlowState(),t={cart:this.currentCart,checkoutSession:e.session},c=await this.orderProcessingService.createOrder(t);if(s(c))return i(o(c));const d=n(c);if(d.requiresPayment&&e.session.selectedPaymentMethod){const t={paymentMethodId:e.session.selectedPaymentMethod.id,orderId:d.order.id,amount:d.order.total,currency:d.order.currency,returnUrl:"/checkout/payment/return",cancelUrl:"/checkout/payment/cancel"},i=await this.paymentService.initializePayment(t);if(a(i)){const e=n(i);return r({...d,paymentUrl:e.redirectUrl})}}return r(d)}catch(e){return i(w.apiError("Checkout completion failed",500,e))}}getAddressFieldRequirements(e){const t={addressType:e,isGuestCheckout:this.getCurrentState()?.session.isGuestCheckout||!1,fieldRequirements:this.config.address,checkoutRules:this.config.validation};return this.addressManager.getFieldRequirements(t)}async validateAddress(e,t){if(!this.currentCart)return i(w.validationError("Checkout not initialized"));const r={checkoutSession:this.getCurrentState()?.session||{},cart:this.currentCart,validationRules:{...this.config.validation},isGuestCheckout:this.getCurrentState()?.session.isGuestCheckout||!1,currentStep:this.getCurrentState()?.currentStep||1};return"billing"===t?this.validationService.validateBillingAddress(r):this.validationService.validateShippingAddress(r)}async getAddressSuggestions(e){return this.addressManager.suggestAddressCorrection(e)}async getShippingRates(e){if(!this.currentCart)return i(w.validationError("Checkout not initialized"));const t=this.getCurrentState(),r=e||(t?.session.useShippingAsBilling?t?.session.billingAddress:t?.session.shippingAddress);if(!r)return i(w.validationError("Shipping address is required"));const a={destination:r,cartItems:this.currentCart.items.map(e=>({productId:e.productId,variationId:e.variationId,quantity:e.quantity,weight:e.weight,dimensions:e.dimensions})),cartTotal:this.currentCart.totals.total,currency:this.currentCart.currency};return this.shippingService.getShippingRates(a)}async calculateShipping(e,t){if(!this.currentCart)return i(w.validationError("Checkout not initialized"));const r=this.getCurrentState(),a=t||(r?.session.useShippingAsBilling?r?.session.billingAddress:r?.session.shippingAddress);return a?this.shippingService.calculateShipping(e,a,this.currentCart.totals.total):i(w.validationError("Shipping address is required"))}async getPaymentMethods(){return this.currentCart?this.paymentService.getAvailablePaymentMethods(this.currentCart.totals.total,this.currentCart.currency):i(w.validationError("Checkout not initialized"))}async validatePaymentMethod(e){if(!this.currentCart)return i(w.validationError("Checkout not initialized"));const t=await this.paymentService.validatePaymentMethod(e,this.currentCart.totals.total,this.currentCart.currency);return s(t)?i(o(t)):r(n(t).isValid)}async getOrder(e){return this.orderProcessingService.getOrder(e)}async confirmOrderPayment(e){return this.orderProcessingService.confirmOrder(e)}async cancelOrder(e,t){return this.orderProcessingService.cancelOrder(e,t)}async searchOrders(e){return this.orderProcessingService.searchOrders(e)}async resetCheckout(){if(this.flowManager){const e=await this.flowManager.resetFlow();return this.flowManager=null,this.currentCart=null,e}return r(void 0)}canProceedToNextStep(){const e=this.getCurrentState();return e?.canProceed||!1}getCurrentStep(){return this.flowManager?.getCurrentStep()||null}isStepCompleted(e){return this.flowManager?.isStepCompleted(e)||!1}generateOrderNumber(){return this.orderProcessingService.generateOrderNumber()}getConfiguration(){return this.config}updateConfiguration(e){Object.assign(this.config,e)}}(new ke).build();exports.ApiError=l,exports.AuthError=d,exports.AuthManager=P,exports.CacheError=S,exports.CacheManager=F,exports.CartError=y,exports.CartService=J,exports.CheckoutError=f,exports.ConfigManager=R,exports.ConfigurationError=m,exports.DEFAULT_CONFIG=I,exports.Err=i,exports.ErrorFactory=w,exports.HttpClient=_,exports.IndexedDBCache=$,exports.LocalStorageCache=q,exports.MemoryCache=D,exports.NetworkError=c,exports.Ok=r,exports.OrderSchema=C,exports.PaymentError=v,exports.ProductNotFoundError=g,exports.ProductSchema=b,exports.ProductService=O,exports.RateLimitError=h,exports.ReviewService=ge,exports.SearchService=ae,exports.TimeoutError=p,exports.UserService=pe,exports.VERSION="1.0.0",exports.ValidationError=u,exports.WooHeadless=class{constructor(e){const t=R.resolveConfig(e);if(!t.success)throw t.error;if(this.config=t.data,this.httpClient=new _(this.config),this.authManager=new P(this.config),this.cacheManager=new F(this.config.cache),this.config.auth.enabled)this.httpClient.addRequestInterceptor(e=>{const t=this.authManager.getAuthorizationHeader();return t?{...e,headers:{...e.headers,...t}}:e});else{const e=P.generateBasicAuth(this.config.consumerKey,this.config.consumerSecret);this.httpClient.addRequestInterceptor(t=>({...t,headers:{...t.headers,Authorization:e}}))}this.products=new O(this.httpClient,this.cacheManager),this.cart=new J(this.httpClient,this.cacheManager,this.config.cart),this.search=new ae(this.httpClient,this.cacheManager,this.config.advancedSearch),this.user=new pe(this.httpClient,this.cacheManager,this.config.userSync),this.checkout=new Pe(this.httpClient,this.cacheManager,this.config.checkout),this.reviews=new ge(this.httpClient,this.cacheManager)}getConfig(){return this.config}getAuth(){return this.authManager}getCache(){return this.cacheManager}getHttpClient(){return this.httpClient}async clearCache(){return this.cacheManager.clear()}async getCacheStats(){return this.cacheManager.getStats()}updateConfig(e){const t={...this.config,...e},r=R.resolveConfig(t);return r.success?(Object.assign(this.config,r.data),e.cache&&(this.cacheManager=new F(this.config.cache)),{success:!0,data:void 0}):r}async healthCheck(){const e=await this.httpClient.get("/");return e.success?{success:!0,data:!0}:e}},exports.andThen=function(e,t){return a(e)?t(e.data):e},exports.isErr=s,exports.isOk=a,exports.isWooCommerceCoupon=function(e){return"object"==typeof e&&null!==e&&"id"in e&&"code"in e&&"amount"in e&&"discount_type"in e},exports.isWooCommerceOrder=function(e){try{return C.parse(e),!0}catch{return!1}},exports.isWooCommerceProduct=function(e){try{return b.parse(e),!0}catch{return!1}},exports.isWooError=function(e){return null!==e&&"object"==typeof e&&"code"in e&&"message"in e&&"timestamp"in e},exports.map=function(e,t){return a(e)?r(t(e.data)):e},exports.mapErr=function(e,t){return s(e)?i(t(e.error)):e},exports.unwrap=n,exports.unwrapErr=o,exports.unwrapOr=function(e,t){return a(e)?e.data:t},exports.validateBaseURL=x,exports.validateCacheConfig=k,exports.validateConsumerCredentials=E;
//# sourceMappingURL=index.cjs.js.map
